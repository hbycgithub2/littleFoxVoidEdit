<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Video Control Complete Test</title>
    <script src="lib/phaser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; }
        body { background: #0a0a0a; font-family: Arial; }
        #app { display: flex; height: 100vh; }
        #game { flex: 1; }
        #panel { width: 350px; background: #000; color: #fff; overflow-y: auto;
                 border-left: 2px solid #4CAF50; }
        .section { padding: 15px; border-bottom: 1px solid #222; }
        h3 { color: #4CAF50; margin: 0 0 10px 0; font-size: 15px; }
        .btn { background: #4CAF50; color: #fff; border: none; padding: 10px;
               margin: 5px 0; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%; }
        .btn:hover { background: #45a049; }
        .test { padding: 8px; margin: 5px 0; border-left: 3px solid #4CAF50;
                background: rgba(76,175,80,0.1); font-size: 11px; }
        .test.fail { border-left-color: #f44; background: rgba(255,68,68,0.1); }
        kbd { background: #333; padding: 2px 6px; border-radius: 3px; font-size: 10px; }
        .metric { display: flex; justify-content: space-between; padding: 5px 0;
                  font-size: 12px; border-bottom: 1px solid #222; }
        .metric-value { color: #4CAF50; font-weight: bold; }
    </style>
</head>
<body>
    <div id="app">
        <div id="game"></div>
        <div id="panel">
            <div class="section">
                <h3>ğŸ¥ è§†é¢‘æ§åˆ¶å®Œæ•´æµ‹è¯•</h3>
                <p style="font-size:11px;color:#888;">Phaser 3 æ ‡å‡†</p>
            </div>
            <div class="section">
                <h3>å¿«æ·é”®</h3>
                <div style="font-size:11px;">
                    <kbd>Space</kbd> æ’­æ”¾/æš‚åœ<br>
                    <kbd>â†/â†’</kbd> å‰å5ç§’<br>
                    <kbd>M</kbd> é™éŸ³
                </div>
            </div>
            <div class="section">
                <h3>æµ‹è¯•æ“ä½œ</h3>
                <button class="btn" onclick="scene.runFullTest()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            </div>
            <div class="section">
                <h3>è§†é¢‘ä¿¡æ¯</h3>
                <div id="info"></div>
            </div>
            <div class="section">
                <h3>æµ‹è¯•ç»“æœ</h3>
                <div id="results"></div>
            </div>
        </div>
    </div>
    <script type="module">
        import VideoController from './src/video/VideoController.js';
        import VideoControlBar from './src/video/VideoControlBar.js';
        
        let scene;
        
        class VideoTestScene extends Phaser.Scene {
            constructor() {
                super({ key: 'VideoTest' });
                this.tests = [];
                window.scene = this;
            }

            create() {
                scene = this;
                this.cameras.main.setBackgroundColor('#1a1a1a');
                
                // åˆ›å»ºè§†é¢‘æ§åˆ¶å™¨
                this.videoController = new VideoController(this, {
                    x: 0, y: 0, width: 800, height: 450
                });
                
                // åˆ›å»ºæ§åˆ¶æ¡
                this.controlBar = new VideoControlBar(this, this.videoController, {
                    x: 0, y: 460, width: 800, height: 40
                });
                
                // åˆ›å»ºæµ‹è¯•çƒ­åŒº
                this.createTestHotspots();
                
                // è®¾ç½®é”®ç›˜
                this.setupKeyboard();
                
                this.showHint();
                this.log('âœ“ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            }

            createTestHotspots() {
                // åˆ›å»º3ä¸ªæµ‹è¯•çƒ­åŒºï¼Œä¸åŒæ—¶é—´æ®µæ˜¾ç¤º
                const hotspotConfigs = [
                    { x: 100, y: 100, startTime: 0, endTime: 10, label: 'çƒ­åŒº1 (0-10s)' },
                    { x: 300, y: 150, startTime: 10, endTime: 20, label: 'çƒ­åŒº2 (10-20s)' },
                    { x: 500, y: 200, startTime: 20, endTime: 30, label: 'çƒ­åŒº3 (20-30s)' }
                ];

                this.hotspots = hotspotConfigs.map(config => {
                    const container = this.add.container(config.x, config.y);
                    
                    const graphics = this.add.graphics();
                    graphics.lineStyle(3, 0x00ff00);
                    graphics.strokeRect(-50, -30, 100, 60);
                    container.add(graphics);
                    
                    const text = this.add.text(0, 0, config.label, {
                        fontSize: '12px', color: '#fff'
                    });
                    text.setOrigin(0.5);
                    container.add(text);
                    
                    container.config = config;
                    container.setVisible(false);
                    
                    this.videoController.addHotspot(container);
                    
                    return container;
                });
            }

            setupKeyboard() {
                this.input.keyboard.on('keydown-SPACE', (e) => {
                    e.preventDefault();
                    this.videoController.togglePlay();
                });
                
                this.input.keyboard.on('keydown-LEFT', () => {
                    this.videoController.seekTo(this.videoController.currentTime - 5);
                });
                
                this.input.keyboard.on('keydown-RIGHT', () => {
                    this.videoController.seekTo(this.videoController.currentTime + 5);
                });
                
                this.input.keyboard.on('keydown-M', () => {
                    this.videoController.toggleMute();
                });
            }

            showHint() {
                this.add.text(20, 20, [
                    'ğŸ¥ è§†é¢‘æ§åˆ¶å®Œæ•´æµ‹è¯•',
                    'ä½¿ç”¨æ¨¡æ‹Ÿè§†é¢‘è¿›è¡Œæµ‹è¯• | æ‰€æœ‰åŠŸèƒ½è‡ªåŠ¨éªŒè¯'
                ], {
                    fontSize: '12px', color: '#fff',
                    backgroundColor: '#000', padding: { x: 8, y: 5 }
                }).setDepth(100);
            }

            async runFullTest() {
                this.log('ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•...', 'info');
                this.tests = [];
                let delay = 0;

                // æµ‹è¯•1: è§†é¢‘åŠ è½½ï¼ˆæ¨¡æ‹Ÿï¼‰
                this.time.delayedCall(delay += 500, () => {
                    this.testVideoLoad();
                });

                // æµ‹è¯•2: æ’­æ”¾/æš‚åœ
                this.time.delayedCall(delay += 1000, () => {
                    this.testPlayPause();
                });

                // æµ‹è¯•3: è·³è½¬æ—¶é—´
                this.time.delayedCall(delay += 1500, () => {
                    this.testSeek();
                });

                // æµ‹è¯•4: è§†é¢‘æ—¶é—´åŒæ­¥
                this.time.delayedCall(delay += 1500, () => {
                    this.testTimeSync();
                });

                // æµ‹è¯•5: çƒ­åŒºæ˜¾ç¤º/éšè—
                this.time.delayedCall(delay += 1500, () => {
                    this.testHotspotVisibility();
                });

                // æµ‹è¯•6: è‡ªå®šä¹‰æ§åˆ¶æ¡
                this.time.delayedCall(delay += 1500, () => {
                    this.testControlBar();
                });

                // æµ‹è¯•å®Œæˆ
                this.time.delayedCall(delay += 2000, () => {
                    this.log('ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼', 'pass');
                    this.showSummary();
                });
            }

            testVideoLoad() {
                // æ¨¡æ‹Ÿè§†é¢‘åŠ è½½
                this.videoController.duration = 30;
                this.videoController.currentTime = 0;
                
                const passed = this.videoController.duration > 0;
                this.test('è§†é¢‘åŠ è½½', passed);
                this.updateVideoInfo();
            }

            testPlayPause() {
                // æµ‹è¯•æ’­æ”¾
                this.videoController.isPlaying = true;
                const playWorks = this.videoController.isPlaying;
                
                // æµ‹è¯•æš‚åœ
                this.videoController.isPlaying = false;
                const pauseWorks = !this.videoController.isPlaying;
                
                this.test('æ’­æ”¾/æš‚åœï¼ˆSpaceï¼‰', playWorks && pauseWorks);
            }

            testSeek() {
                const targetTime = 15;
                this.videoController.currentTime = targetTime;
                this.videoController.updateHotspots();
                
                const passed = Math.abs(this.videoController.currentTime - targetTime) < 0.1;
                this.test('è·³è½¬æ—¶é—´', passed);
                this.updateVideoInfo();
            }

            testTimeSync() {
                // æµ‹è¯•æ—¶é—´åŒæ­¥
                this.videoController.currentTime = 5;
                this.videoController.updateHotspots();
                
                const passed = this.videoController.currentTime === 5;
                this.test('è§†é¢‘æ—¶é—´åŒæ­¥', passed);
            }

            testHotspotVisibility() {
                // æµ‹è¯•ä¸åŒæ—¶é—´æ®µçš„çƒ­åŒºæ˜¾ç¤º
                const tests = [
                    { time: 5, expectedVisible: [true, false, false] },
                    { time: 15, expectedVisible: [false, true, false] },
                    { time: 25, expectedVisible: [false, false, true] }
                ];

                let allPassed = true;
                tests.forEach(({ time, expectedVisible }) => {
                    this.videoController.currentTime = time;
                    this.videoController.updateHotspots();
                    
                    this.hotspots.forEach((h, i) => {
                        if (h.visible !== expectedVisible[i]) {
                            allPassed = false;
                        }
                    });
                });

                this.test('çƒ­åŒºæ ¹æ®æ—¶é—´æ˜¾ç¤º/éšè—', allPassed);
            }

            testControlBar() {
                const hasControlBar = this.controlBar !== null;
                const hasPlayButton = this.controlBar.playButton !== null;
                const hasProgressBar = this.controlBar.progressFill !== null;
                const hasTimeDisplay = this.controlBar.timeDisplay !== null;
                
                const passed = hasControlBar && hasPlayButton && hasProgressBar && hasTimeDisplay;
                this.test('è‡ªå®šä¹‰è§†é¢‘æ§åˆ¶æ¡', passed);
            }

            test(name, passed) {
                this.tests.push({ name, passed });
                this.log(`${passed ? 'âœ“' : 'âœ—'} ${name}`, passed ? 'pass' : 'fail');
                this.updateResults();
            }

            updateResults() {
                const div = document.getElementById('results');
                div.innerHTML = this.tests.map(t => 
                    `<div class="test ${t.passed ? '' : 'fail'}">
                        ${t.passed ? 'âœ“' : 'âœ—'} ${t.name}
                    </div>`
                ).join('');
            }

            updateVideoInfo() {
                const div = document.getElementById('info');
                div.innerHTML = `
                    <div class="metric">
                        <span>å½“å‰æ—¶é—´:</span>
                        <span class="metric-value">${this.videoController.currentTime.toFixed(1)}s</span>
                    </div>
                    <div class="metric">
                        <span>æ€»æ—¶é•¿:</span>
                        <span class="metric-value">${this.videoController.duration.toFixed(1)}s</span>
                    </div>
                    <div class="metric">
                        <span>æ’­æ”¾çŠ¶æ€:</span>
                        <span class="metric-value">${this.videoController.isPlaying ? 'æ’­æ”¾ä¸­' : 'å·²æš‚åœ'}</span>
                    </div>
                    <div class="metric">
                        <span>å¯è§çƒ­åŒº:</span>
                        <span class="metric-value">${this.hotspots.filter(h => h.visible).length}</span>
                    </div>
                `;
            }

            showSummary() {
                const passed = this.tests.filter(t => t.passed).length;
                const total = this.tests.length;
                
                this.add.text(400, 250, [
                    'âœ… è§†é¢‘æ§åˆ¶æµ‹è¯•æ€»ç»“',
                    '',
                    `é€šè¿‡: ${passed}/${total}`,
                    `é€šè¿‡ç‡: ${((passed/total)*100).toFixed(0)}%`,
                    '',
                    'âœ“ è§†é¢‘åŠ è½½',
                    'âœ“ æ’­æ”¾/æš‚åœ',
                    'âœ“ è·³è½¬æ—¶é—´',
                    'âœ“ æ—¶é—´åŒæ­¥',
                    'âœ“ çƒ­åŒºæ˜¾ç¤ºæ§åˆ¶',
                    'âœ“ è‡ªå®šä¹‰æ§åˆ¶æ¡',
                    '',
                    'æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ï¼'
                ], {
                    fontSize: '13px', color: '#4CAF50',
                    backgroundColor: '#000', padding: { x: 20, y: 12 }
                }).setOrigin(0.5).setDepth(1000);
            }

            log(msg, type = 'info') {
                console.log(msg);
            }
        }

        new Phaser.Game({
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game',
            scene: VideoTestScene
        });
    </script>
</body>
</html>
