<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¶é—´è½´å¯¼å‡º/å¯¼å…¥åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        h2 {
            color: #00ff00;
            margin-top: 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #00ff00;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: #000;
        }
        button:hover {
            background: #00cc00;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .info-box {
            padding: 15px;
            background: #333;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        .success {
            color: #00ff00;
        }
        .error {
            color: #ff6666;
        }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 400px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .stat-item {
            padding: 10px;
            background: #333;
            border-radius: 5px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ff00;
        }
        .stat-label {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—‚ï¸ æ—¶é—´è½´å¯¼å‡º/å¯¼å…¥åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="section">
            <h2>åŠŸèƒ½è¯´æ˜</h2>
            <div class="info-box">
                <p><strong>å·²å®ç°åŠŸèƒ½ï¼š</strong></p>
                <ul>
                    <li>âœ… å¯¼å‡ºå®Œæ•´æ—¶é—´è½´æ•°æ®ä¸º JSON</li>
                    <li>âœ… å¯¼å‡ºçƒ­åŒºæ•°æ®ä¸º CSV</li>
                    <li>âœ… å¯¼å…¥ JSON æ•°æ®</li>
                    <li>âœ… æ•°æ®éªŒè¯å’Œé”™è¯¯å¤„ç†</li>
                    <li>âœ… æ”¯æŒé€‰æ‹©æ€§å¯¼å…¥ï¼ˆçƒ­åŒºã€å›¾å±‚ã€æ ‡è®°ç­‰ï¼‰</li>
                    <li>âœ… æ–‡ä»¶ä¸‹è½½å’Œä¸Šä¼ </li>
                    <li>âœ… æ•°æ®ç»Ÿè®¡ä¿¡æ¯</li>
                </ul>
                
                <p><strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong></p>
                <ul>
                    <li>å³é”®ç‚¹å‡»æ—¶é—´è½´ç©ºç™½åŒºåŸŸ â†’ å¯¼å‡º/å¯¼å…¥é€‰é¡¹</li>
                    <li>å¿«æ·é”®ï¼šCtrl+E å¯¼å‡ºï¼ŒCtrl+I å¯¼å…¥ï¼ˆéœ€è¦åœ¨å®é™…é¡¹ç›®ä¸­é…ç½®ï¼‰</li>
                    <li>æ”¯æŒæ‹–æ‹½ JSON æ–‡ä»¶åˆ°æ—¶é—´è½´å¯¼å…¥</li>
                </ul>
            </div>
        </div>
        
        <div class="section">
            <h2>æ•°æ®ç»Ÿè®¡</h2>
            <div class="stats" id="stats">
                <div class="stat-item">
                    <div class="stat-value" id="hotspot-count">0</div>
                    <div class="stat-label">çƒ­åŒºæ•°é‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="layer-count">0</div>
                    <div class="stat-label">å›¾å±‚æ•°é‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="marker-count">0</div>
                    <div class="stat-label">æ ‡è®°æ•°é‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="duration">0.00s</div>
                    <div class="stat-label">è§†é¢‘æ—¶é•¿</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>å¯¼å‡ºåŠŸèƒ½æµ‹è¯•</h2>
            <button onclick="testExportJSON()">å¯¼å‡ºä¸º JSON</button>
            <button onclick="testExportCSV()">å¯¼å‡ºä¸º CSV</button>
            <button onclick="testGetData()">æŸ¥çœ‹å¯¼å‡ºæ•°æ®</button>
            <div id="export-result" class="info-box" style="display: none;">
                <pre id="export-data"></pre>
            </div>
        </div>
        
        <div class="section">
            <h2>å¯¼å…¥åŠŸèƒ½æµ‹è¯•</h2>
            <button onclick="testImportDialog()">é€‰æ‹©æ–‡ä»¶å¯¼å…¥</button>
            <button onclick="testImportSample()">å¯¼å…¥ç¤ºä¾‹æ•°æ®</button>
            <button onclick="testClearData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
            <div id="import-result" class="info-box" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h2>æ•°æ®éªŒè¯æµ‹è¯•</h2>
            <button onclick="testValidation()">æµ‹è¯•æ•°æ®éªŒè¯</button>
            <div id="validation-result" class="info-box" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h2>äº‹ä»¶ç›‘å¬</h2>
            <div class="info-box">
                <div id="event-log" style="max-height: 200px; overflow-y: auto;">
                    <p style="color: #666;">ç­‰å¾…äº‹ä»¶...</p>
                </div>
            </div>
            <button onclick="clearEventLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>
    </div>

    <script type="module">
        import TimelineDataController from './src/dom/timeline/TimelineDataController.js';
        
        // æ¨¡æ‹Ÿç¯å¢ƒ
        const mockScene = {
            registry: {
                data: { hotspots: [] },
                get: function(key) { return this.data[key] || []; },
                set: function(key, value) { this.data[key] = value; }
            },
            events: {
                emit: (event, data) => logEvent(event, data),
                on: () => {}
            },
            layerManager: {
                layers: [
                    { id: 1, name: 'Layer 1', visible: true, locked: false, hotspots: [] },
                    { id: 2, name: 'Layer 2', visible: true, locked: false, hotspots: [] }
                ],
                getLayers: function() { return this.layers; },
                getLayer: function(id) { return this.layers.find(l => l.id === id); },
                addLayer: function(name) {
                    const layer = { 
                        id: this.layers.length + 1, 
                        name, 
                        visible: true, 
                        locked: false, 
                        hotspots: [] 
                    };
                    this.layers.push(layer);
                    return layer;
                }
            },
            hotspots: [],
            createHotspot: function(config) {
                this.hotspots.push({ config });
                this.registry.set('hotspots', this.registry.get('hotspots').concat([config]));
            }
        };
        
        const mockTimeline = {
            scene: mockScene,
            game: { events: { emit: () => {} } },
            videoDuration: 120,
            currentTime: 0,
            scale: 10,
            virtualScrollController: { scrollY: 0 },
            layerGroupController: {
                isLayerCollapsed: () => false,
                collapsedLayers: new Map()
            },
            markerController: {
                markers: [],
                clearAllMarkers: function() { this.markers = []; }
            },
            rangeController: {
                getRange: () => null,
                setRange: () => {},
                startLoop: () => {},
                isLooping: false
            },
            keyboardController: {
                inPoint: null,
                outPoint: null
            },
            render: () => {}
        };
        
        // åˆ›å»ºæ§åˆ¶å™¨
        window.dataController = new TimelineDataController(mockTimeline);
        window.mockScene = mockScene;
        
        // æ·»åŠ ç¤ºä¾‹æ•°æ®
        function addSampleData() {
            mockScene.registry.set('hotspots', [
                {
                    id: 'hotspot-1',
                    shape: 'rectangle',
                    layerId: 1,
                    startTime: 5,
                    endTime: 10,
                    x: 100,
                    y: 100,
                    width: 200,
                    height: 150,
                    word: 'Sample 1',
                    strokeColor: '#00ff00',
                    fillColor: 'rgba(0, 255, 0, 0.3)',
                    strokeWidth: 2,
                    visible: true,
                    locked: false
                },
                {
                    id: 'hotspot-2',
                    shape: 'circle',
                    layerId: 2,
                    startTime: 15,
                    endTime: 25,
                    x: 300,
                    y: 200,
                    radius: 80,
                    word: 'Sample 2',
                    strokeColor: '#ff0000',
                    fillColor: 'rgba(255, 0, 0, 0.3)',
                    strokeWidth: 2,
                    visible: true,
                    locked: false
                }
            ]);
            
            mockTimeline.markerController.markers = [
                { id: 'marker-1', time: 10, label: 'Marker 1', type: 'default', color: '#00bfff' },
                { id: 'marker-2', time: 20, label: 'Marker 2', type: 'important', color: '#ff0000' }
            ];
            
            updateStats();
        }
        
        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            const stats = window.dataController.getStats();
            document.getElementById('hotspot-count').textContent = stats.hotspotCount;
            document.getElementById('layer-count').textContent = stats.layerCount;
            document.getElementById('marker-count').textContent = stats.markerCount;
            document.getElementById('duration').textContent = stats.totalDuration.toFixed(2) + 's';
        }
        
        // äº‹ä»¶æ—¥å¿—
        function logEvent(event, data) {
            const log = document.getElementById('event-log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color: #666;">[${time}]</span> <span style="color: #00ff00;">${event}</span>`;
            if (data) {
                entry.innerHTML += `<br><span style="color: #aaa; margin-left: 20px;">${JSON.stringify(data, null, 2)}</span>`;
            }
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        window.clearEventLog = function() {
            document.getElementById('event-log').innerHTML = '<p style="color: #666;">ç­‰å¾…äº‹ä»¶...</p>';
        };
        
        // æµ‹è¯•å‡½æ•°
        window.testExportJSON = function() {
            addSampleData();
            window.dataController.downloadJSON();
            logEvent('æ‰‹åŠ¨è§¦å‘', { action: 'exportJSON' });
        };
        
        window.testExportCSV = function() {
            addSampleData();
            window.dataController.downloadCSV();
            logEvent('æ‰‹åŠ¨è§¦å‘', { action: 'exportCSV' });
        };
        
        window.testGetData = function() {
            addSampleData();
            const data = window.dataController.exportData();
            document.getElementById('export-data').textContent = JSON.stringify(data, null, 2);
            document.getElementById('export-result').style.display = 'block';
            logEvent('æ‰‹åŠ¨è§¦å‘', { action: 'getData' });
        };
        
        window.testImportDialog = function() {
            window.dataController.showFileDialog();
            logEvent('æ‰‹åŠ¨è§¦å‘', { action: 'importDialog' });
        };
        
        window.testImportSample = function() {
            const sampleData = {
                version: '1.0.0',
                exportTime: new Date().toISOString(),
                video: { duration: 120, currentTime: 0 },
                timeline: { scale: 10, scrollY: 0 },
                hotspots: [
                    {
                        id: 'imported-1',
                        shape: 'rectangle',
                        layerId: 1,
                        startTime: 30,
                        endTime: 40,
                        x: 150,
                        y: 150,
                        width: 180,
                        height: 120,
                        word: 'Imported',
                        strokeColor: '#ffaa00',
                        fillColor: 'rgba(255, 170, 0, 0.3)',
                        strokeWidth: 2,
                        visible: true,
                        locked: false
                    }
                ],
                layers: [],
                markers: [],
                range: null,
                inOutPoints: { inPoint: null, outPoint: null }
            };
            
            const success = window.dataController.importData(sampleData, { clearExisting: false });
            const resultDiv = document.getElementById('import-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = success 
                ? '<span class="success">âœ… å¯¼å…¥æˆåŠŸï¼</span>' 
                : '<span class="error">âŒ å¯¼å…¥å¤±è´¥ï¼</span>';
            
            updateStats();
            logEvent('æ‰‹åŠ¨è§¦å‘', { action: 'importSample', success });
        };
        
        window.testClearData = function() {
            window.dataController.clearAllData();
            updateStats();
            logEvent('æ‰‹åŠ¨è§¦å‘', { action: 'clearData' });
        };
        
        window.testValidation = function() {
            const tests = [
                { name: 'æœ‰æ•ˆæ•°æ®', data: { version: '1.0.0', hotspots: [], layers: [] }, expected: true },
                { name: 'ç¼ºå°‘ç‰ˆæœ¬', data: { hotspots: [] }, expected: false },
                { name: 'æ— æ•ˆçƒ­åŒº', data: { version: '1.0.0', hotspots: 'invalid' }, expected: false },
                { name: 'null æ•°æ®', data: null, expected: false }
            ];
            
            const results = tests.map(test => {
                const result = window.dataController.validateData(test.data);
                return `${test.name}: ${result === test.expected ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`;
            });
            
            const resultDiv = document.getElementById('validation-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = results.join('<br>');
            
            logEvent('æ‰‹åŠ¨è§¦å‘', { action: 'validation', results });
        };
        
        // åˆå§‹åŒ–
        addSampleData();
        updateStats();
        logEvent('ç³»ç»Ÿ', { message: 'æ—¶é—´è½´æ•°æ®æ§åˆ¶å™¨å·²åˆå§‹åŒ–' });
    </script>
</body>
</html>
