<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>çº¹ç†åŠ è½½ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        #console {
            background: #000;
            color: #0f0;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 600px;
            overflow-y: auto;
            border-radius: 4px;
            margin: 20px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #45a049; }
    </style>
</head>
<body>
    <h1>ğŸ§ª çº¹ç†åŠ è½½ä¿®å¤æµ‹è¯•</h1>
    <p>æµ‹è¯• textures.on('addtexture') ä¿®å¤æ–¹æ¡ˆ</p>
    
    <button onclick="runTest()">è¿è¡Œæµ‹è¯•</button>
    <button onclick="clearConsole()">æ¸…ç©ºæ—¥å¿—</button>
    
    <div id="console"></div>
    
    <script>
        const consoleDiv = document.getElementById('console');
        const originalLog = console.log;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleDiv.innerHTML += '<div>' + message + '</div>';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };
        
        function clearConsole() {
            consoleDiv.innerHTML = '';
        }
    </script>
    
    <script src="lib/phaser.min.js"></script>
    
    <script>
        // åˆ›å»ºç®€å•çš„Phaseråœºæ™¯
        class TestScene extends Phaser.Scene {
            constructor() {
                super({ key: 'TestScene' });
            }
            
            create() {
                console.log('âœ… TestScene created');
                this.container = this.add.container(0, 0);
                
                // æµ‹è¯•èƒŒæ™¯
                const bg = this.add.graphics();
                bg.fillStyle(0x333333, 1);
                bg.fillRect(0, 0, 800, 100);
                this.container.add(bg);
            }
        }
        
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 100,
            backgroundColor: '#000000',
            scene: TestScene
        };
        
        const game = new Phaser.Game(config);
        window.testGame = game;
        
        console.log('âœ… Phaser Gameå·²åˆ›å»º');
        
        // æµ‹è¯•å‡½æ•°
        async function runTest() {
            console.log('\n========== å¼€å§‹æµ‹è¯• ==========\n');
            
            const scene = game.scene.getScene('TestScene');
            if (!scene) {
                console.error('âŒ Sceneæœªæ‰¾åˆ°');
                return;
            }
            
            console.log('âœ… Sceneå·²æ‰¾åˆ°');
            
            // ç”Ÿæˆ3ä¸ªæµ‹è¯•çº¹ç†
            const testImages = [];
            
            for (let i = 0; i < 3; i++) {
                const textureKey = `test_texture_${i}`;
                const base64 = generateTestImage(i);
                
                console.log(`\nğŸ¨ æµ‹è¯•çº¹ç†#${i}:`);
                console.log(`  Key: ${textureKey}`);
                
                // åˆ›å»ºImageå¯¹è±¡
                const image = scene.add.image(i * 100 + 50, 50, '__DEFAULT');
                image.setDisplaySize(80, 60);
                scene.container.add(image);
                testImages.push(image);
                
                console.log(`  âœ… Imageå·²åˆ›å»º`);
                
                // ä½¿ç”¨ä¿®å¤åçš„æ–¹æ¡ˆï¼šå…ˆç›‘å¬ï¼Œå†æ·»åŠ 
                const onTextureAdded = (key) => {
                    if (key === textureKey) {
                        console.log(`  ğŸ‰ çº¹ç†åŠ è½½å®Œæˆ: ${key}`);
                        
                        // è®¾ç½®çº¹ç†
                        image.setTexture(textureKey);
                        
                        // éªŒè¯
                        const texture = scene.textures.get(textureKey);
                        console.log(`  âœ… çº¹ç†å·²è®¾ç½®:`, {
                            key: texture.key,
                            width: texture.source[0]?.width,
                            height: texture.source[0]?.height,
                            imageTexture: image.texture.key
                        });
                        
                        // ç§»é™¤ç›‘å¬å™¨
                        scene.textures.off('addtexture', onTextureAdded);
                    }
                };
                
                // å…ˆç›‘å¬
                scene.textures.on('addtexture', onTextureAdded);
                console.log(`  ğŸ“¡ ç›‘å¬å™¨å·²è®¾ç½®`);
                
                // å†æ·»åŠ 
                scene.textures.addBase64(textureKey, base64);
                console.log(`  ğŸ“¤ çº¹ç†å·²æäº¤åŠ è½½`);
                
                // ç­‰å¾…ä¸€ä¸‹
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            console.log('\n========== æµ‹è¯•å®Œæˆ ==========\n');
            console.log('ğŸ’¡ æ£€æŸ¥ä¸Šæ–¹ç”»å¸ƒï¼Œåº”è¯¥çœ‹åˆ°3ä¸ªä¸åŒé¢œè‰²çš„çŸ©å½¢');
            
            // æœ€ç»ˆéªŒè¯
            setTimeout(() => {
                console.log('\nğŸ“Š æœ€ç»ˆéªŒè¯:');
                testImages.forEach((img, i) => {
                    console.log(`  Image#${i}:`, {
                        texture: img.texture.key,
                        size: `${img.texture.source[0]?.width}x${img.texture.source[0]?.height}`,
                        valid: img.texture.key !== '__DEFAULT' && img.texture.key !== '__MISSING'
                    });
                });
            }, 500);
        }
        
        // ç”Ÿæˆæµ‹è¯•å›¾ç‰‡ï¼ˆä¸åŒé¢œè‰²ï¼‰
        function generateTestImage(index) {
            const canvas = document.createElement('canvas');
            canvas.width = 80;
            canvas.height = 60;
            const ctx = canvas.getContext('2d');
            
            // ä¸åŒé¢œè‰²
            const colors = ['#ff0000', '#00ff00', '#0000ff'];
            ctx.fillStyle = colors[index];
            ctx.fillRect(0, 0, 80, 60);
            
            // æ·»åŠ æ–‡å­—
            ctx.fillStyle = '#ffffff';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`#${index}`, 40, 30);
            
            return canvas.toDataURL('image/png');
        }
    </script>
</body>
</html>
