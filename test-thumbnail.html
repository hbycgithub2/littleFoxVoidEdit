<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼©ç•¥å›¾é¢„è§ˆåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #00ff00;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            margin-left: 10px;
            font-weight: bold;
        }
        .status.pass { background: #00ff00; color: #000; }
        .status.fail { background: #ff0000; color: #fff; }
        .status.pending { background: #ffaa00; color: #000; }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #00ff00;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #00cc00;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            background: #333;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .thumbnail-preview {
            display: inline-block;
            margin: 5px;
            padding: 5px;
            background: #1a1a1a;
            border: 1px solid #666;
            border-radius: 3px;
        }
        .thumbnail-preview canvas {
            display: block;
            border: 1px solid #00ff00;
        }
    </style>
</head>
<body>
    <h1>ğŸ–¼ï¸ ç¼©ç•¥å›¾é¢„è§ˆåŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>æµ‹è¯• 1: æ§åˆ¶å™¨åˆå§‹åŒ– <span id="test1-status" class="status pending">å¾…æµ‹è¯•</span></h3>
        <p>éªŒè¯ TimelineThumbnailController æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–</p>
        <button onclick="test1()">è¿è¡Œæµ‹è¯•</button>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯• 2: ç¼©ç•¥å›¾ç”Ÿæˆ <span id="test2-status" class="status pending">å¾…æµ‹è¯•</span></h3>
        <p>æµ‹è¯•ç¼©ç•¥å›¾ç”ŸæˆåŠŸèƒ½ï¼ˆæ¨¡æ‹Ÿçƒ­åŒºï¼‰</p>
        <button onclick="test2()">è¿è¡Œæµ‹è¯•</button>
        <div id="thumbnail-container"></div>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯• 3: ç¼“å­˜ç®¡ç† <span id="test3-status" class="status pending">å¾…æµ‹è¯•</span></h3>
        <p>æµ‹è¯•ç¼“å­˜æ·»åŠ ã€è·å–ã€æ¸…é™¤åŠŸèƒ½</p>
        <button onclick="test3()">è¿è¡Œæµ‹è¯•</button>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯• 4: æ‰¹é‡ç”Ÿæˆ <span id="test4-status" class="status pending">å¾…æµ‹è¯•</span></h3>
        <p>æµ‹è¯•æ‰¹é‡ç”Ÿæˆé˜Ÿåˆ—å’Œå¼‚æ­¥å¤„ç†</p>
        <button onclick="test4()">è¿è¡Œæµ‹è¯•</button>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯• 5: Canvas ç»˜åˆ¶ <span id="test5-status" class="status pending">å¾…æµ‹è¯•</span></h3>
        <p>æµ‹è¯•ç¼©ç•¥å›¾ç»˜åˆ¶åˆ° Canvas</p>
        <button onclick="test5()">è¿è¡Œæµ‹è¯•</button>
        <canvas id="test-canvas" width="400" height="100" style="border: 1px solid #666; margin-top: 10px;"></canvas>
    </div>
    
    <div class="test-section">
        <h3>å…¨éƒ¨æµ‹è¯•</h3>
        <button onclick="runAllTests()">è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
    </div>
    
    <div id="results"></div>

    <script type="module">
        import TimelineThumbnailController from './src/dom/timeline/TimelineThumbnailController.js';
        
        // æ¨¡æ‹Ÿ TimelinePanel å’Œ Scene
        const mockScene = {
            events: {
                emit: (event, data) => {
                    log(`Event: ${event}`, data);
                }
            },
            hotspots: []
        };
        
        const mockTimeline = {
            scene: mockScene,
            game: { events: { emit: () => {} } },
            canvas: document.getElementById('test-canvas'),
            scale: 10,
            render: () => {}
        };
        
        // åˆ›å»ºæ§åˆ¶å™¨å®ä¾‹
        window.thumbnailController = new TimelineThumbnailController(mockTimeline);
        
        function log(message, data = null) {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
            if (data) {
                results.textContent += JSON.stringify(data, null, 2) + '\n';
            }
            results.scrollTop = results.scrollHeight;
        }
        
        function setStatus(testId, status) {
            const element = document.getElementById(`${testId}-status`);
            element.className = `status ${status}`;
            element.textContent = status === 'pass' ? 'âœ… é€šè¿‡' : status === 'fail' ? 'âŒ å¤±è´¥' : 'â³ å¾…æµ‹è¯•';
        }
        
        // æµ‹è¯• 1: æ§åˆ¶å™¨åˆå§‹åŒ–
        window.test1 = function() {
            log('=== æµ‹è¯• 1: æ§åˆ¶å™¨åˆå§‹åŒ– ===');
            try {
                const controller = window.thumbnailController;
                
                // æ£€æŸ¥å±æ€§
                if (!controller.thumbnailCache) throw new Error('thumbnailCache æœªåˆå§‹åŒ–');
                if (controller.enabled !== true) throw new Error('enabled é»˜è®¤å€¼é”™è¯¯');
                if (controller.thumbnailWidth !== 60) throw new Error('thumbnailWidth é»˜è®¤å€¼é”™è¯¯');
                if (controller.thumbnailHeight !== 16) throw new Error('thumbnailHeight é»˜è®¤å€¼é”™è¯¯');
                if (controller.maxCacheSize !== 100) throw new Error('maxCacheSize é»˜è®¤å€¼é”™è¯¯');
                
                log('âœ… æ§åˆ¶å™¨åˆå§‹åŒ–æˆåŠŸ');
                log('é…ç½®:', {
                    enabled: controller.enabled,
                    thumbnailWidth: controller.thumbnailWidth,
                    thumbnailHeight: controller.thumbnailHeight,
                    maxCacheSize: controller.maxCacheSize
                });
                
                setStatus('test1', 'pass');
            } catch (error) {
                log('âŒ æµ‹è¯•å¤±è´¥:', error.message);
                setStatus('test1', 'fail');
            }
        };
        
        // æµ‹è¯• 2: ç¼©ç•¥å›¾ç”Ÿæˆ
        window.test2 = async function() {
            log('=== æµ‹è¯• 2: ç¼©ç•¥å›¾ç”Ÿæˆ ===');
            try {
                const controller = window.thumbnailController;
                
                // åˆ›å»ºæ¨¡æ‹Ÿçƒ­åŒº
                const mockHotspot = {
                    config: {
                        id: 'test-hotspot-1',
                        shape: 'rectangle',
                        x: 50,
                        y: 50,
                        width: 100,
                        height: 80,
                        strokeColor: '#00ff00',
                        fillColor: 'rgba(0, 255, 0, 0.3)',
                        strokeWidth: 2,
                        word: 'Test'
                    },
                    getBounds: () => ({ x: 50, y: 50, width: 100, height: 80 })
                };
                
                mockScene.hotspots = [mockHotspot];
                
                log('ç”Ÿæˆç¼©ç•¥å›¾ä¸­...');
                const thumbnail = await controller.generateThumbnail('test-hotspot-1');
                
                if (!thumbnail) throw new Error('ç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥');
                if (!(thumbnail instanceof Image)) throw new Error('è¿”å›å€¼ä¸æ˜¯ Image å¯¹è±¡');
                
                // æ˜¾ç¤ºç¼©ç•¥å›¾
                const container = document.getElementById('thumbnail-container');
                const preview = document.createElement('div');
                preview.className = 'thumbnail-preview';
                preview.innerHTML = '<p>ç”Ÿæˆçš„ç¼©ç•¥å›¾:</p>';
                preview.appendChild(thumbnail);
                container.appendChild(preview);
                
                log('âœ… ç¼©ç•¥å›¾ç”ŸæˆæˆåŠŸ');
                log('ç¼©ç•¥å›¾å°ºå¯¸:', {
                    width: thumbnail.width,
                    height: thumbnail.height
                });
                
                setStatus('test2', 'pass');
            } catch (error) {
                log('âŒ æµ‹è¯•å¤±è´¥:', error.message);
                setStatus('test2', 'fail');
            }
        };
        
        // æµ‹è¯• 3: ç¼“å­˜ç®¡ç†
        window.test3 = function() {
            log('=== æµ‹è¯• 3: ç¼“å­˜ç®¡ç† ===');
            try {
                const controller = window.thumbnailController;
                
                // åˆ›å»ºæµ‹è¯•å›¾åƒ
                const testImg = new Image();
                testImg.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
                
                // æµ‹è¯•ç¼“å­˜æ·»åŠ 
                controller.cacheThumbnail('test-1', testImg);
                if (controller.thumbnailCache.size !== 1) throw new Error('ç¼“å­˜æ·»åŠ å¤±è´¥');
                
                // æµ‹è¯•ç¼“å­˜è·å–
                const cached = controller.getThumbnail('test-1');
                if (cached !== testImg) throw new Error('ç¼“å­˜è·å–å¤±è´¥');
                
                // æµ‹è¯•ç¼“å­˜ç»Ÿè®¡
                const stats = controller.getCacheStats();
                if (stats.size !== 1) throw new Error('ç¼“å­˜ç»Ÿè®¡é”™è¯¯');
                
                // æµ‹è¯•ç¼“å­˜æ¸…é™¤
                controller.clearCache('test-1');
                if (controller.thumbnailCache.size !== 0) throw new Error('ç¼“å­˜æ¸…é™¤å¤±è´¥');
                
                log('âœ… ç¼“å­˜ç®¡ç†åŠŸèƒ½æ­£å¸¸');
                log('ç¼“å­˜ç»Ÿè®¡:', stats);
                
                setStatus('test3', 'pass');
            } catch (error) {
                log('âŒ æµ‹è¯•å¤±è´¥:', error.message);
                setStatus('test3', 'fail');
            }
        };
        
        // æµ‹è¯• 4: æ‰¹é‡ç”Ÿæˆ
        window.test4 = async function() {
            log('=== æµ‹è¯• 4: æ‰¹é‡ç”Ÿæˆ ===');
            try {
                const controller = window.thumbnailController;
                
                // åˆ›å»ºå¤šä¸ªæ¨¡æ‹Ÿçƒ­åŒº
                for (let i = 0; i < 5; i++) {
                    const mockHotspot = {
                        config: {
                            id: `batch-test-${i}`,
                            shape: 'rectangle',
                            x: 50 + i * 20,
                            y: 50,
                            width: 80,
                            height: 60,
                            strokeColor: '#00ff00',
                            fillColor: 'rgba(0, 255, 0, 0.3)'
                        },
                        getBounds: () => ({ x: 50 + i * 20, y: 50, width: 80, height: 60 })
                    };
                    mockScene.hotspots.push(mockHotspot);
                }
                
                const ids = ['batch-test-0', 'batch-test-1', 'batch-test-2', 'batch-test-3', 'batch-test-4'];
                
                log('æ‰¹é‡ç”Ÿæˆ 5 ä¸ªç¼©ç•¥å›¾...');
                controller.batchGenerate(ids);
                
                // ç­‰å¾…ç”Ÿæˆå®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const stats = controller.getCacheStats();
                log('âœ… æ‰¹é‡ç”Ÿæˆå®Œæˆ');
                log('é˜Ÿåˆ—çŠ¶æ€:', stats);
                
                setStatus('test4', 'pass');
            } catch (error) {
                log('âŒ æµ‹è¯•å¤±è´¥:', error.message);
                setStatus('test4', 'fail');
            }
        };
        
        // æµ‹è¯• 5: Canvas ç»˜åˆ¶
        window.test5 = function() {
            log('=== æµ‹è¯• 5: Canvas ç»˜åˆ¶ ===');
            try {
                const controller = window.thumbnailController;
                const canvas = document.getElementById('test-canvas');
                const ctx = canvas.getContext('2d');
                
                // æ¸…ç©ºç”»å¸ƒ
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // æ¨¡æ‹Ÿçƒ­åŒºé…ç½®
                const config = {
                    id: 'test-hotspot-1',
                    word: 'Test Hotspot'
                };
                
                // ç»˜åˆ¶ç¼©ç•¥å›¾ï¼ˆå¦‚æœæœ‰ç¼“å­˜ï¼‰
                controller.drawThumbnail(ctx, config, 10, 10, 200, 30);
                
                // ç»˜åˆ¶å ä½ç¬¦æµ‹è¯•
                const config2 = {
                    id: 'non-existent',
                    word: 'Loading...'
                };
                controller.drawThumbnail(ctx, config2, 220, 10, 150, 30);
                
                log('âœ… Canvas ç»˜åˆ¶å®Œæˆ');
                log('å·²ç»˜åˆ¶ç¼©ç•¥å›¾å’Œå ä½ç¬¦åˆ°æµ‹è¯•ç”»å¸ƒ');
                
                setStatus('test5', 'pass');
            } catch (error) {
                log('âŒ æµ‹è¯•å¤±è´¥:', error.message);
                setStatus('test5', 'fail');
            }
        };
        
        // è¿è¡Œå…¨éƒ¨æµ‹è¯•
        window.runAllTests = async function() {
            log('========================================');
            log('å¼€å§‹è¿è¡Œå…¨éƒ¨æµ‹è¯•...');
            log('========================================');
            
            test1();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await test2();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            test3();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await test4();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            test5();
            
            log('========================================');
            log('å…¨éƒ¨æµ‹è¯•å®Œæˆï¼');
            log('========================================');
        };
        
        log('ç¼©ç•¥å›¾é¢„è§ˆåŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
        log('ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•');
    </script>
</body>
</html>
