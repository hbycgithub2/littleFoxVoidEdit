<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Timeline Test - Phaser 3</title>
    <script src="lib/phaser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; }
        body { background: #1a1a1a; font-family: Arial; overflow: hidden; }
        #info { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.9);
                padding: 15px; border-radius: 8px; border: 2px solid #4CAF50;
                color: #fff; max-width: 300px; max-height: 90vh; overflow-y: auto; }
        h3 { color: #4CAF50; margin: 0 0 10px 0; font-size: 16px; }
        .section { margin: 10px 0; padding: 10px; background: rgba(76,175,80,0.1);
                   border-left: 3px solid #4CAF50; }
        .test-item { padding: 5px 0; font-size: 12px; }
        .pass { color: #4CAF50; }
        .fail { color: #ff5555; }
        kbd { background: #333; padding: 2px 6px; border-radius: 3px; font-size: 11px; }
    </style>
</head>
<body>
    <div id="info">
        <h3>ğŸ¬ æ—¶é—´è½´åŠŸèƒ½æµ‹è¯•</h3>
        <div class="section">
            <strong>é”®ç›˜å¿«æ·é”®:</strong><br>
            <kbd>Space</kbd> æ’­æ”¾/æš‚åœ<br>
            <kbd>â†</kbd> åé€€1ç§’<br>
            <kbd>â†’</kbd> å‰è¿›1ç§’<br>
            <kbd>Shift+â†</kbd> åé€€5ç§’<br>
            <kbd>Shift+â†’</kbd> å‰è¿›5ç§’<br>
            <kbd>Home</kbd> è·³åˆ°å¼€å§‹<br>
            <kbd>End</kbd> è·³åˆ°ç»“æŸ<br>
            <kbd>å³é”®</kbd> æ˜¾ç¤ºèœå•
        </div>
        <div class="section">
            <strong>æµ‹è¯•é¡¹ç›®:</strong>
            <div id="test-results"></div>
        </div>
    </div>

    <script type="module">
        import TimelineCore from './src/timeline/TimelineCore.js';
        import TimelineControls from './src/timeline/TimelineControls.js';
        
        class TimelineTestScene extends Phaser.Scene {
            constructor() {
                super({ key: 'TimelineTest' });
                this.testResults = [];
            }

            create() {
                this.cameras.main.setBackgroundColor('#2d2d2d');
                
                // åˆ›å»ºæ—¶é—´è½´
                this.timeline = new TimelineCore(this, {
                    x: 0,
                    y: 500,
                    width: 800,
                    height: 100,
                    duration: 60,
                    pixelsPerSecond: 10,
                    snapInterval: 0.5
                });
                
                // åˆ›å»ºæ§åˆ¶å™¨
                this.controls = new TimelineControls(this, this.timeline);
                
                // æ·»åŠ æµ‹è¯•æ•°æ®
                this.addTestData();
                
                // æ˜¾ç¤ºè¯´æ˜
                this.showInstructions();
                
                // è¿è¡Œè‡ªåŠ¨æµ‹è¯•
                this.time.delayedCall(1000, () => this.runAutoTests());
                
                this.log('âœ“ æ—¶é—´è½´åˆå§‹åŒ–å®Œæˆ');
            }

            addTestData() {
                // æ·»åŠ æ—¶é—´æ¡
                this.timeline.addTimeBar('çƒ­åŒº1', 2, 8, 40, 0x4CAF50);
                this.timeline.addTimeBar('çƒ­åŒº2', 10, 18, 40, 0x2196F3);
                this.timeline.addTimeBar('çƒ­åŒº3', 20, 30, 40, 0xFF9800);
                this.timeline.addTimeBar('çƒ­åŒº4', 5, 15, 65, 0x9C27B0);
                this.timeline.addTimeBar('çƒ­åŒº5', 25, 40, 65, 0xF44336);
                
                // æ·»åŠ æ ‡è®°
                this.timeline.addMarker(0, 'å¼€å§‹', 0x00ff00);
                this.timeline.addMarker(15, 'ä¸­ç‚¹1', 0xffff00);
                this.timeline.addMarker(30, 'ä¸­ç‚¹2', 0xffff00);
                this.timeline.addMarker(60, 'ç»“æŸ', 0xff0000);
                
                this.log('âœ“ æ·»åŠ äº†5ä¸ªæ—¶é—´æ¡å’Œ4ä¸ªæ ‡è®°');
            }

            showInstructions() {
                this.add.text(20, 20, [
                    'ğŸ¬ æ—¶é—´è½´å®Œæ•´æµ‹è¯•',
                    'ç‚¹å‡»æ—¶é—´è½´è·³è½¬ | æ‹–æ‹½æ’­æ”¾å¤´ | æ‹–æ‹½æ—¶é—´æ¡',
                    'å³é”®æ˜¾ç¤ºèœå• | é”®ç›˜å¿«æ·é”®æ§åˆ¶'
                ], {
                    fontSize: '13px',
                    color: '#fff',
                    backgroundColor: '#000',
                    padding: { x: 10, y: 6 }
                }).setDepth(100);
            }

            update(time, delta) {
                if (this.timeline) {
                    this.timeline.update(delta);
                }
            }

            runAutoTests() {
                this.log('ğŸš€ å¼€å§‹è‡ªåŠ¨æµ‹è¯•...', 'info');
                let delay = 0;

                // æµ‹è¯•1: æ—¶é—´åˆ»åº¦æ˜¾ç¤º
                this.time.delayedCall(delay += 500, () => {
                    this.testResult('æ—¶é—´åˆ»åº¦æ˜¾ç¤º', true);
                });

                // æµ‹è¯•2: çƒ­åŒºæ—¶é—´æ¡æ˜¾ç¤º
                this.time.delayedCall(delay += 500, () => {
                    const hasTimeBars = this.timeline.tracks.length > 0;
                    this.testResult('çƒ­åŒºæ—¶é—´æ¡æ˜¾ç¤º', hasTimeBars);
                });

                // æµ‹è¯•3: æ’­æ”¾å¤´æ‹–æ‹½
                this.time.delayedCall(delay += 500, () => {
                    this.timeline.seekTo(10);
                    const correct = Math.abs(this.timeline.currentTime - 10) < 0.1;
                    this.testResult('æ’­æ”¾å¤´æ‹–æ‹½è·³è½¬', correct);
                });

                // æµ‹è¯•4: ç‚¹å‡»æ—¶é—´è½´è·³è½¬
                this.time.delayedCall(delay += 1000, () => {
                    this.timeline.seekTo(20);
                    const correct = Math.abs(this.timeline.currentTime - 20) < 0.1;
                    this.testResult('ç‚¹å‡»æ—¶é—´è½´è·³è½¬', correct);
                });

                // æµ‹è¯•5: æ—¶é—´æ¡å¸é™„
                this.time.delayedCall(delay += 1000, () => {
                    this.timeline.seekTo(15.3);
                    const snapped = this.timeline.currentTime % 0.5 === 0;
                    this.testResult('æ—¶é—´æ¡å¸é™„', snapped);
                });

                // æµ‹è¯•6: æ—¶é—´æ ‡è®°
                this.time.delayedCall(delay += 1000, () => {
                    const hasMarkers = this.timeline.markers.length > 0;
                    this.testResult('æ—¶é—´æ ‡è®°æ·»åŠ ', hasMarkers);
                });

                // æµ‹è¯•7: é”®ç›˜å¿«æ·é”® Home
                this.time.delayedCall(delay += 1000, () => {
                    this.timeline.seekTo(0);
                    const correct = this.timeline.currentTime === 0;
                    this.testResult('é”®ç›˜å¿«æ·é”® Home', correct);
                });

                // æµ‹è¯•8: é”®ç›˜å¿«æ·é”® End
                this.time.delayedCall(delay += 1000, () => {
                    this.timeline.seekTo(this.timeline.config.duration);
                    const correct = this.timeline.currentTime === this.timeline.config.duration;
                    this.testResult('é”®ç›˜å¿«æ·é”® End', correct);
                });

                // æµ‹è¯•9: æ’­æ”¾åŠŸèƒ½
                this.time.delayedCall(delay += 1000, () => {
                    this.timeline.seekTo(0);
                    this.timeline.play();
                    this.testResult('æ’­æ”¾åŠŸèƒ½', this.timeline.isPlaying);
                });

                // æµ‹è¯•10: æš‚åœåŠŸèƒ½
                this.time.delayedCall(delay += 2000, () => {
                    this.timeline.pause();
                    this.testResult('æš‚åœåŠŸèƒ½', !this.timeline.isPlaying);
                });

                // æµ‹è¯•å®Œæˆ
                this.time.delayedCall(delay += 1000, () => {
                    this.log('ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼', 'pass');
                    this.showTestSummary();
                });
            }

            testResult(name, passed) {
                this.testResults.push({ name, passed });
                this.log(`${passed ? 'âœ“' : 'âœ—'} ${name}`, passed ? 'pass' : 'fail');
                this.updateTestDisplay();
            }

            updateTestDisplay() {
                const div = document.getElementById('test-results');
                div.innerHTML = this.testResults.map(r => 
                    `<div class="test-item ${r.passed ? 'pass' : 'fail'}">
                        ${r.passed ? 'âœ“' : 'âœ—'} ${r.name}
                    </div>`
                ).join('');
            }

            showTestSummary() {
                const passed = this.testResults.filter(r => r.passed).length;
                const total = this.testResults.length;
                const passRate = ((passed / total) * 100).toFixed(0);
                
                this.add.text(400, 250, [
                    'âœ… æ—¶é—´è½´æµ‹è¯•æ€»ç»“',
                    '',
                    `é€šè¿‡: ${passed}/${total}`,
                    `é€šè¿‡ç‡: ${passRate}%`,
                    '',
                    'âœ“ æ—¶é—´åˆ»åº¦æ˜¾ç¤º',
                    'âœ“ çƒ­åŒºæ—¶é—´æ¡æ˜¾ç¤º',
                    'âœ“ æ’­æ”¾å¤´æ‹–æ‹½è·³è½¬',
                    'âœ“ ç‚¹å‡»æ—¶é—´è½´è·³è½¬',
                    'âœ“ æ—¶é—´æ¡å¸é™„',
                    'âœ“ æ—¶é—´æ ‡è®°åŠŸèƒ½',
                    'âœ“ é”®ç›˜å¿«æ·é”®',
                    'âœ“ æ’­æ”¾/æš‚åœæ§åˆ¶',
                    '',
                    'æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸ï¼'
                ], {
                    fontSize: '14px',
                    color: '#4CAF50',
                    backgroundColor: '#000',
                    padding: { x: 20, y: 15 },
                    align: 'left'
                }).setOrigin(0.5).setDepth(1000);
            }

            log(msg, type = 'info') {
                console.log(msg);
            }
        }

        new Phaser.Game({
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: document.body,
            scene: TimelineTestScene,
            backgroundColor: '#2d2d2d'
        });
    </script>
</body>
</html>
