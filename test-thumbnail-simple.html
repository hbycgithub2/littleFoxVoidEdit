<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¶é—´è½´ç¼©ç•¥å›¾ - ç®€åŒ–æµ‹è¯•</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #4CAF50; margin-bottom: 20px; }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        video {
            width: 100%;
            max-width: 800px;
            border-radius: 8px;
            margin: 10px 0;
        }
        #phaserContainer {
            margin: 20px 0;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            background: #000;
            position: relative;
            z-index: 1000;
        }
        #phaserContainer canvas {
            display: block;
            border-radius: 6px;
        }
        #console {
            background: #000;
            color: #0f0;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 400px;
            overflow-y: auto;
            border-radius: 4px;
            margin-top: 10px;
        }
        .status {
            background: #1e3a5f;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #2196F3;
        }
        .error { border-left-color: #f44336; background: #3a1e1e; }
        .success { border-left-color: #4CAF50; background: #1e3a1e; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ æ—¶é—´è½´ç¼©ç•¥å›¾ - ç®€åŒ–æµ‹è¯•</h1>
        
        <div class="section">
            <h3>æ­¥éª¤1ï¼šåŠ è½½è§†é¢‘</h3>
            <video id="video" controls preload="metadata" crossorigin="anonymous">
                <source src="assets/videos/001_I_Can_Hop.mp4" type="video/mp4">
            </video>
            <div id="videoStatus" class="status">ç­‰å¾…è§†é¢‘åŠ è½½...</div>
        </div>
        
        <div class="section">
            <h3>æ­¥éª¤2ï¼šå¯ç”¨å¹¶ç”Ÿæˆç¼©ç•¥å›¾</h3>
            <button id="enableBtn" onclick="enableThumbnails()">1. å¯ç”¨ç¼©ç•¥å›¾åŠŸèƒ½</button>
            <button id="generateBtn" onclick="generateThumbnails()" disabled>2. ç”Ÿæˆç¼©ç•¥å›¾</button>
            <button onclick="runDiagnostics()">ğŸ” è¿è¡Œè¯Šæ–­</button>
            <button onclick="clearConsole()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="section">
            <h3>æ­¥éª¤3ï¼šæŸ¥çœ‹ç¼©ç•¥å›¾</h3>
            <div id="phaserContainer"></div>
            <p style="color: #888; margin-top: 10px;">
                ğŸ’¡ æç¤ºï¼šç¼©ç•¥å›¾ä¼šæ˜¾ç¤ºåœ¨ä¸Šæ–¹çš„é»‘è‰²åŒºåŸŸä¸­<br>
                - æ‹–æ‹½æ»šåŠ¨æŸ¥çœ‹<br>
                - æ»šè½®ç¼©æ”¾
            </p>
        </div>
        
        <div class="section">
            <h3>æ§åˆ¶å°è¾“å‡º</h3>
            <div id="console"></div>
        </div>
    </div>
    
    <script>
        // æ‹¦æˆªconsole.log
        const consoleDiv = document.getElementById('console');
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleDiv.innerHTML += '<div style="color: #0f0;">' + message + '</div>';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleDiv.innerHTML += '<div style="color: #f44;">' + message + '</div>';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };
        
        function clearConsole() {
            consoleDiv.innerHTML = '';
        }
        
        function updateStatus(message, type = 'status') {
            const statusDiv = document.getElementById('videoStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
        }
        
        // è§†é¢‘åŠ è½½ç›‘å¬
        const video = document.getElementById('video');
        video.addEventListener('loadedmetadata', () => {
            console.log('âœ… è§†é¢‘åŠ è½½å®Œæˆ:', {
                duration: video.duration,
                width: video.videoWidth,
                height: video.videoHeight
            });
            updateStatus(`è§†é¢‘å·²åŠ è½½ (${video.duration.toFixed(2)}ç§’)`, 'success');
        });
        
        video.addEventListener('error', (e) => {
            console.error('âŒ è§†é¢‘åŠ è½½å¤±è´¥:', e);
            updateStatus('è§†é¢‘åŠ è½½å¤±è´¥', 'error');
        });
        
        function enableThumbnails() {
            console.log('\n=== å¯ç”¨ç¼©ç•¥å›¾åŠŸèƒ½ ===');
            
            if (!window.thumbnailInitializer) {
                console.error('âŒ thumbnailInitializeræœªæ‰¾åˆ°');
                updateStatus('åˆå§‹åŒ–å™¨æœªåŠ è½½', 'error');
                return;
            }
            
            if (!window.game) {
                console.error('âŒ Phaser Gameæœªæ‰¾åˆ°');
                updateStatus('PhaseræœªåŠ è½½', 'error');
                return;
            }
            
            console.log('âœ… å¼€å§‹å¯ç”¨...');
            window.thumbnailInitializer.enable('v3.0');
            
            setTimeout(() => {
                const scene = window.game.scene.getScene('TimelineThumbnailScene');
                if (scene) {
                    console.log('âœ… Sceneå·²åˆ›å»º');
                    console.log('  thumbnailLayer:', !!scene.thumbnailLayer);
                    console.log('  renderer:', !!window.thumbnailInitializer.renderer);
                    
                    document.getElementById('enableBtn').disabled = true;
                    document.getElementById('generateBtn').disabled = false;
                    updateStatus('ç¼©ç•¥å›¾åŠŸèƒ½å·²å¯ç”¨', 'success');
                } else {
                    console.error('âŒ Sceneåˆ›å»ºå¤±è´¥');
                    updateStatus('Sceneåˆ›å»ºå¤±è´¥', 'error');
                }
            }, 600);
        }
        
        function generateThumbnails() {
            console.log('\n=== ç”Ÿæˆç¼©ç•¥å›¾ ===');
            
            if (!video.duration) {
                console.error('âŒ è§†é¢‘æœªåŠ è½½');
                updateStatus('è¯·å…ˆç­‰å¾…è§†é¢‘åŠ è½½', 'error');
                return;
            }
            
            console.log('âœ… å¼€å§‹ç”Ÿæˆ...');
            updateStatus('æ­£åœ¨ç”Ÿæˆç¼©ç•¥å›¾...', 'status');
            
            window.thumbnailInitializer.loadVideo(video);
            document.getElementById('generateBtn').disabled = true;
            
            // ç›‘å¬è¿›åº¦
            let progressCount = 0;
            const checkProgress = setInterval(() => {
                if (window.thumbnailInitializer.renderer) {
                    const stats = window.thumbnailInitializer.renderer.getStats();
                    if (stats.totalFrames > 0) {
                        updateStatus(`å·²ç”Ÿæˆ ${stats.totalFrames} å¸§ï¼Œå¯è§ ${stats.visibleThumbnails} ä¸ª`, 'success');
                        if (stats.visibleThumbnails > 0) {
                            clearInterval(checkProgress);
                        }
                    }
                }
                progressCount++;
                if (progressCount > 20) clearInterval(checkProgress);
            }, 500);
        }
        
        function runDiagnostics() {
            console.log('\n========== æ·±åº¦è¯Šæ–­ ==========');
            console.log('ğŸ“¦ å…¨å±€å¯¹è±¡:');
            console.log('  game:', !!window.game);
            console.log('  thumbnailInitializer:', !!window.thumbnailInitializer);
            
            if (window.game) {
                const scene = window.game.scene.getScene('TimelineThumbnailScene');
                console.log('\nğŸ¬ Scene:');
                console.log('  å­˜åœ¨:', !!scene);
                if (scene) {
                    console.log('  thumbnailLayer:', !!scene.thumbnailLayer);
                    console.log('  thumbnailLayer.list.length:', scene.thumbnailLayer?.list.length);
                    console.log('  cameras.main:', !!scene.cameras.main);
                }
            }
            
            if (window.thumbnailInitializer) {
                console.log('\nğŸ”§ Initializer:');
                console.log('  initialized:', window.thumbnailInitializer.initialized);
                console.log('  enabled:', window.thumbnailInitializer.config.enabled);
                console.log('  renderer:', !!window.thumbnailInitializer.renderer);
                
                if (window.thumbnailInitializer.renderer) {
                    const stats = window.thumbnailInitializer.renderer.getStats();
                    console.log('\nğŸ¨ Rendererç»Ÿè®¡:');
                    console.log('  ', stats);
                }
            }
            
            console.log('\nğŸ“¹ Video:');
            console.log('  duration:', video.duration);
            console.log('  readyState:', video.readyState);
            console.log('========== è¯Šæ–­å®Œæˆ ==========\n');
        }
        
        console.log('ğŸš€ ç®€åŒ–æµ‹è¯•é¡µé¢å·²åŠ è½½');
        console.log('ğŸ’¡ æ“ä½œæ­¥éª¤:');
        console.log('  1. ç­‰å¾…è§†é¢‘åŠ è½½å®Œæˆ');
        console.log('  2. ç‚¹å‡»"å¯ç”¨ç¼©ç•¥å›¾åŠŸèƒ½"');
        console.log('  3. ç‚¹å‡»"ç”Ÿæˆç¼©ç•¥å›¾"');
        console.log('  4. æŸ¥çœ‹ä¸Šæ–¹é»‘è‰²åŒºåŸŸçš„ç¼©ç•¥å›¾\n');
    </script>
    
    <!-- Phaser 3 åº“ -->
    <script src="lib/phaser.min.js"></script>
    
    <!-- æœ€å°åŒ–çš„Phaseré…ç½® -->
    <script type="module">
        import ThumbnailConfig from './src/phaser/timeline/ThumbnailConfig.js';
        import ThumbnailInitializer from './src/phaser/timeline/ThumbnailInitializer.js';
        
        // åˆ›å»ºæœ€å°åŒ–çš„Phaser Game
        const config = {
            type: Phaser.AUTO,
            parent: 'phaserContainer',
            width: 1200,
            height: 100,
            backgroundColor: '#000000',
            scene: []  // ç©ºåœºæ™¯ï¼Œç”±ThumbnailInitializeræ·»åŠ 
        };
        
        const game = new Phaser.Game(config);
        
        // åˆ›å»ºThumbnailInitializer
        const thumbnailInitializer = new ThumbnailInitializer(game);
        
        // å¯¼å‡ºåˆ°å…¨å±€
        window.game = game;
        window.thumbnailInitializer = thumbnailInitializer;
        
        console.log('âœ… Phaser Gameå·²åˆ›å»º');
        console.log('âœ… ThumbnailInitializerå·²åˆ›å»º');
    </script>
</body>
</html>
