<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Layer Management Test</title>
    <script src="lib/phaser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0a0a; font-family: Arial; overflow: hidden; }
        #app { display: flex; height: 100vh; }
        #game { flex: 1; }
        #panel { width: 380px; background: #000; color: #fff; overflow-y: auto;
                 border-left: 2px solid #4CAF50; }
        .section { padding: 15px; border-bottom: 1px solid #222; }
        h3 { color: #4CAF50; margin: 0 0 10px 0; font-size: 15px; }
        .btn { background: #4CAF50; color: #fff; border: none; padding: 10px;
               margin: 5px 0; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%; }
        .btn:hover { background: #45a049; transform: translateY(-1px); }
        .btn-primary { background: #2196F3; }
        .btn-danger { background: #f44336; }
        .layer-item { padding: 10px; margin: 5px 0; background: #1a1a1a;
                      border-radius: 4px; border-left: 3px solid #4CAF50; }
        .layer-item.active { background: #2a2a2a; border-left-color: #ffeb3b; }
        .layer-controls { display: flex; gap: 5px; margin-top: 5px; }
        .layer-btn { padding: 5px 10px; font-size: 11px; flex: 1; }
        .test { padding: 8px; margin: 5px 0; border-left: 3px solid #4CAF50;
                background: rgba(76,175,80,0.1); font-size: 11px; }
        .test.fail { border-left-color: #f44; background: rgba(255,68,68,0.1); }
        .metric { display: flex; justify-content: space-between; padding: 5px 0;
                  font-size: 12px; border-bottom: 1px solid #222; }
        .metric-value { color: #4CAF50; font-weight: bold; }
    </style>
</head>
<body>
    <div id="app">
        <div id="game"></div>
        <div id="panel">
            <div class="section">
                <h3>ğŸ“š å›¾å±‚ç®¡ç†æµ‹è¯•</h3>
                <p style="font-size:11px;color:#888;">Phaser 3 æ ‡å‡†</p>
            </div>
            
            <div class="section">
                <h3>å›¾å±‚æ“ä½œ</h3>
                <button class="btn" onclick="scene.createNewLayer()">â• åˆ›å»ºå›¾å±‚</button>
                <button class="btn btn-danger" onclick="scene.deleteActiveLayer()">ğŸ—‘ï¸ åˆ é™¤å½“å‰å›¾å±‚</button>
            </div>
            
            <div class="section">
                <h3>å›¾å±‚åˆ—è¡¨</h3>
                <div id="layer-list"></div>
            </div>
            
            <div class="section">
                <h3>ğŸš€ è‡ªåŠ¨æµ‹è¯•</h3>
                <button class="btn btn-primary" onclick="scene.runFullTest()">
                    è¿è¡Œå®Œæ•´æµ‹è¯•
                </button>
            </div>
            
            <div class="section">
                <h3>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
                <div id="stats"></div>
            </div>
            
            <div class="section">
                <h3>ğŸ“ æµ‹è¯•ç»“æœ</h3>
                <div id="results"></div>
            </div>
        </div>
    </div>
    <script type="module">
        import LayerManager from './src/layer/LayerManager.js';
        import LayerValidator from './src/layer/LayerValidator.js';
        
        let scene;
        
        class LayerTestScene extends Phaser.Scene {
            constructor() {
                super({ key: 'LayerTest' });
                this.tests = [];
                window.scene = this;
            }

            create() {
                scene = this;
                this.cameras.main.setBackgroundColor('#1a1a1a');
                
                // åˆå§‹åŒ–å›¾å±‚ç®¡ç†å™¨
                this.layerManager = new LayerManager(this);
                this.validator = new LayerValidator(this.layerManager);
                
                // åˆ›å»ºæµ‹è¯•çƒ­åŒº
                this.createTestHotspots();
                
                // ç›‘å¬å›¾å±‚äº‹ä»¶
                this.setupLayerEvents();
                
                // æ›´æ–°UI
                this.updateLayerList();
                this.updateStats();
                
                this.showHint();
                this.log('âœ“ å›¾å±‚ç®¡ç†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            }

            createTestHotspots() {
                const colors = [0x4CAF50, 0x2196F3, 0xFF9800];
                
                for (let i = 0; i < 3; i++) {
                    const container = this.add.container(150 + i * 200, 200);
                    
                    const graphics = this.add.graphics();
                    graphics.lineStyle(3, colors[i]);
                    graphics.strokeRect(-50, -40, 100, 80);
                    container.add(graphics);
                    
                    const text = this.add.text(0, 0, `çƒ­åŒº${i+1}`, {
                        fontSize: '14px', color: '#fff'
                    });
                    text.setOrigin(0.5);
                    container.add(text);
                    
                    // æ·»åŠ åˆ°å½“å‰æ´»åŠ¨å›¾å±‚
                    this.layerManager.addHotspotToLayer(container);
                }
            }

            setupLayerEvents() {
                this.events.on('layer:created', () => {
                    this.updateLayerList();
                    this.updateStats();
                });
                
                this.events.on('layer:deleted', () => {
                    this.updateLayerList();
                    this.updateStats();
                });
                
                this.events.on('layer:visibilityChanged', () => {
                    this.updateLayerList();
                });
                
                this.events.on('layer:lockChanged', () => {
                    this.updateLayerList();
                });
                
                this.events.on('layer:orderChanged', () => {
                    this.updateLayerList();
                });
                
                this.events.on('layer:renamed', () => {
                    this.updateLayerList();
                });
                
                this.events.on('layer:activeChanged', () => {
                    this.updateLayerList();
                });
            }

            showHint() {
                this.add.text(20, 20, [
                    'ğŸ“š å›¾å±‚ç®¡ç†å®Œæ•´æµ‹è¯•',
                    'åˆ›å»ºã€åˆ é™¤ã€æ˜¾ç¤º/éšè—ã€é”å®šã€æ’åºã€é‡å‘½å'
                ], {
                    fontSize: '12px', color: '#fff',
                    backgroundColor: '#000', padding: { x: 8, y: 5 }
                }).setDepth(100);
            }

            createNewLayer() {
                const name = `å›¾å±‚ ${this.layerManager.getLayerCount() + 1}`;
                this.layerManager.createLayer(name);
                this.log(`âœ“ åˆ›å»ºå›¾å±‚: ${name}`, 'pass');
            }

            deleteActiveLayer() {
                const activeLayer = this.layerManager.getActiveLayer();
                if (activeLayer) {
                    const success = this.layerManager.deleteLayer(activeLayer.id);
                    if (success) {
                        this.log(`âœ“ åˆ é™¤å›¾å±‚: ${activeLayer.name}`, 'pass');
                    } else {
                        this.log('âœ— åˆ é™¤å¤±è´¥', 'fail');
                    }
                }
            }

            toggleLayerVisibility(layerId) {
                this.layerManager.toggleLayerVisibility(layerId);
            }

            toggleLayerLock(layerId) {
                this.layerManager.toggleLayerLock(layerId);
            }

            moveLayerUp(layerId) {
                this.layerManager.moveLayerUp(layerId);
            }

            moveLayerDown(layerId) {
                this.layerManager.moveLayerDown(layerId);
            }

            renameLayer(layerId) {
                const newName = prompt('è¾“å…¥æ–°åç§°:');
                if (newName) {
                    this.layerManager.renameLayer(layerId, newName);
                }
            }

            setActiveLayer(layerId) {
                this.layerManager.setActiveLayer(layerId);
            }

            updateLayerList() {
                const div = document.getElementById('layer-list');
                const layers = this.layerManager.getLayers();
                const activeLayer = this.layerManager.getActiveLayer();
                
                div.innerHTML = layers.map(layer => `
                    <div class="layer-item ${layer === activeLayer ? 'active' : ''}"
                         onclick="scene.setActiveLayer('${layer.id}')">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <span style="font-weight:bold;">${layer.name}</span>
                            <span style="font-size:10px;color:#888;">
                                ${layer.visible ? 'ğŸ‘' : 'ğŸš«'} 
                                ${layer.locked ? 'ğŸ”’' : 'ğŸ”“'}
                            </span>
                        </div>
                        <div class="layer-controls">
                            <button class="btn layer-btn" 
                                    onclick="event.stopPropagation();scene.toggleLayerVisibility('${layer.id}')">
                                ${layer.visible ? 'éšè—' : 'æ˜¾ç¤º'}
                            </button>
                            <button class="btn layer-btn" 
                                    onclick="event.stopPropagation();scene.toggleLayerLock('${layer.id}')">
                                ${layer.locked ? 'è§£é”' : 'é”å®š'}
                            </button>
                            <button class="btn layer-btn" 
                                    onclick="event.stopPropagation();scene.moveLayerUp('${layer.id}')">
                                â¬†ï¸
                            </button>
                            <button class="btn layer-btn" 
                                    onclick="event.stopPropagation();scene.moveLayerDown('${layer.id}')">
                                â¬‡ï¸
                            </button>
                            <button class="btn layer-btn" 
                                    onclick="event.stopPropagation();scene.renameLayer('${layer.id}')">
                                âœï¸
                            </button>
                        </div>
                    </div>
                `).reverse().join('');
            }

            updateStats() {
                const div = document.getElementById('stats');
                const layers = this.layerManager.getLayers();
                const visibleCount = layers.filter(l => l.visible).length;
                const lockedCount = layers.filter(l => l.locked).length;
                
                div.innerHTML = `
                    <div class="metric">
                        <span>æ€»å›¾å±‚æ•°:</span>
                        <span class="metric-value">${layers.length}</span>
                    </div>
                    <div class="metric">
                        <span>å¯è§å›¾å±‚:</span>
                        <span class="metric-value">${visibleCount}</span>
                    </div>
                    <div class="metric">
                        <span>é”å®šå›¾å±‚:</span>
                        <span class="metric-value">${lockedCount}</span>
                    </div>
                    <div class="metric">
                        <span>æ´»åŠ¨å›¾å±‚:</span>
                        <span class="metric-value">${this.layerManager.getActiveLayer()?.name || 'N/A'}</span>
                    </div>
                `;
            }

            async runFullTest() {
                this.log('ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•...', 'info');
                this.tests = [];
                
                const report = await this.validator.runFullValidation();
                
                this.displayReport(report);
                this.showSummary(report);
            }

            displayReport(report) {
                const div = document.getElementById('results');
                div.innerHTML = report.tests.map(t => 
                    `<div class="test ${t.passed ? '' : 'fail'}">
                        ${t.passed ? 'âœ“' : 'âœ—'} ${t.name} (${t.duration}ms)
                    </div>`
                ).join('');
            }

            showSummary(report) {
                const passed = report.summary.passed;
                const total = report.summary.total;
                
                this.add.text(400, 300, [
                    'âœ… å›¾å±‚ç®¡ç†æµ‹è¯•æ€»ç»“',
                    '',
                    `é€šè¿‡: ${passed}/${total}`,
                    `é€šè¿‡ç‡: ${report.summary.passRate}`,
                    `æ€»è€—æ—¶: ${report.summary.totalDuration}`,
                    '',
                    'âœ“ åˆ›å»ºå›¾å±‚',
                    'âœ“ åˆ é™¤å›¾å±‚',
                    'âœ“ æ˜¾ç¤º/éšè—',
                    'âœ“ é”å®š/è§£é”',
                    'âœ“ å›¾å±‚æ’åº',
                    'âœ“ å›¾å±‚é‡å‘½å',
                    '',
                    passed === total ? 'ğŸ‰ å®Œç¾é€šè¿‡ï¼' : 'âš ï¸ éƒ¨åˆ†åŠŸèƒ½éœ€ä¼˜åŒ–'
                ], {
                    fontSize: '13px',
                    color: passed === total ? '#4CAF50' : '#FF9800',
                    backgroundColor: '#000',
                    padding: { x: 20, y: 12 }
                }).setOrigin(0.5).setDepth(1000);
            }

            log(msg, type = 'info') {
                console.log(msg);
            }
        }

        new Phaser.Game({
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game',
            scene: LayerTestScene
        });
    </script>
</body>
</html>
