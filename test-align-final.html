<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Align Final Test - Phaser 3</title>
    <script src="lib/phaser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #1a1a1a; font-family: 'Segoe UI', Arial; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #game-area { flex: 1; }
        #control-panel { width: 350px; background: #000; color: #fff; 
                         overflow-y: auto; border-left: 2px solid #2196F3; }
        .panel-section { padding: 15px; border-bottom: 1px solid #333; }
        .panel-section h3 { color: #2196F3; margin-bottom: 10px; font-size: 16px; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; }
        .btn { background: #2196F3; color: #fff; border: none; padding: 8px 12px;
               border-radius: 4px; cursor: pointer; font-size: 11px; flex: 1; min-width: 100px; }
        .btn:hover { background: #1976D2; }
        .btn-success { background: #4CAF50; }
        .btn-success:hover { background: #45a049; }
        .btn-danger { background: #f44336; }
        .btn-danger:hover { background: #da190b; }
        .test-result { padding: 8px; margin: 5px 0; border-left: 3px solid #4CAF50;
                       background: rgba(76, 175, 80, 0.1); font-size: 12px; }
        .test-result.fail { border-left-color: #f44336; background: rgba(244, 67, 54, 0.1); }
        .metric { display: flex; justify-content: space-between; padding: 5px 0;
                  font-size: 12px; border-bottom: 1px solid #222; }
        .metric-value { color: #4CAF50; font-weight: bold; }
        #report { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="container">
        <div id="game-area"></div>
        <div id="control-panel">
            <div class="panel-section">
                <h3>ğŸ¯ å¯¹é½åˆ†å¸ƒç»ˆææµ‹è¯•</h3>
                <p style="font-size:12px; color:#888;">å®Œå…¨éµå¾ª Phaser 3 å®˜æ–¹æ ‡å‡†</p>
            </div>
            
            <div class="panel-section">
                <h3>é€‰æ‹©æ“ä½œ</h3>
                <div class="btn-group">
                    <button class="btn" onclick="scene.selectAll()">å…¨é€‰ (A)</button>
                    <button class="btn" onclick="scene.clearSel()">æ¸…é™¤</button>
                    <button class="btn" onclick="scene.selectRandom(3)">éšæœº3ä¸ª</button>
                </div>
            </div>
            
            <div class="panel-section">
                <h3>å¯¹é½æ“ä½œ</h3>
                <div class="btn-group">
                    <button class="btn" onclick="scene.alignLeft()">â† å·¦ (1)</button>
                    <button class="btn" onclick="scene.alignRight()">â†’ å³ (2)</button>
                    <button class="btn" onclick="scene.alignCenterH()">â†” æ°´å¹³ä¸­ (3)</button>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="scene.alignTop()">â†‘ é¡¶ (4)</button>
                    <button class="btn" onclick="scene.alignBottom()">â†“ åº• (5)</button>
                    <button class="btn" onclick="scene.alignCenterV()">â†• å‚ç›´ä¸­ (6)</button>
                </div>
            </div>
            
            <div class="panel-section">
                <h3>åˆ†å¸ƒæ“ä½œ</h3>
                <div class="btn-group">
                    <button class="btn" onclick="scene.distributeH()">æ°´å¹³åˆ†å¸ƒ (7)</button>
                    <button class="btn" onclick="scene.distributeV()">å‚ç›´åˆ†å¸ƒ (8)</button>
                </div>
            </div>
            
            <div class="panel-section">
                <h3>ç‰¹æ®Šæ“ä½œ</h3>
                <div class="btn-group">
                    <button class="btn" onclick="scene.alignCanvas()">ç”»å¸ƒå±…ä¸­ (9)</button>
                    <button class="btn btn-danger" onclick="scene.reset()">é‡ç½® (R)</button>
                </div>
            </div>
            
            <div class="panel-section">
                <h3>è‡ªåŠ¨åŒ–æµ‹è¯•</h3>
                <button class="btn btn-success" onclick="scene.runValidation()" 
                        style="width:100%; padding:12px; font-size:13px;">
                    ğŸš€ è¿è¡Œå®Œæ•´éªŒè¯æµ‹è¯•
                </button>
            </div>
            
            <div class="panel-section">
                <h3>æµ‹è¯•æŠ¥å‘Š</h3>
                <div id="report"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import AlignDistributeValidator from './src/utils/AlignDistributeValidator.js';
        
        let scene;
        
        class AlignFinalScene extends Phaser.Scene {
            constructor() {
                super({ key: 'AlignFinal' });
                this.hotspots = [];
                this.selected = [];
                this.initialPos = [];
                window.scene = this;
            }

            create() {
                scene = this;
                this.cameras.main.setBackgroundColor('#2d2d2d');
                
                this.createGrid();
                this.createHotspots();
                this.setupKeyboard();
                this.validator = new AlignDistributeValidator(this);
                
                this.showHint();
                this.log('âœ“ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            }

            createGrid() {
                const g = this.add.graphics();
                g.lineStyle(1, 0x333333, 0.3);
                for (let x = 0; x <= 800; x += 50) g.lineBetween(x, 0, x, 600);
                for (let y = 0; y <= 600; y += 50) g.lineBetween(0, y, 800, y);
                g.setDepth(-1);
            }

            createHotspots() {
                const pos = [
                    {x:100,y:100}, {x:250,y:130}, {x:400,y:110}, {x:550,y:120},
                    {x:120,y:250}, {x:280,y:280}, {x:430,y:260}, {x:580,y:270},
                    {x:150,y:400}, {x:300,y:430}, {x:450,y:410}, {x:600,y:420}
                ];

                pos.forEach((p, i) => {
                    const c = this.add.container(p.x, p.y);
                    const g = this.add.graphics();
                    g.lineStyle(3, 0x00ff00);
                    g.strokeRect(-40, -30, 80, 60);
                    c.add(g);
                    
                    const t = this.add.text(0, 0, (i+1).toString(), {
                        fontSize: '16px', color: '#fff', fontStyle: 'bold'
                    });
                    t.setOrigin(0.5);
                    c.add(t);
                    
                    c.setData('g', g);
                    c.setData('sel', false);
                    
                    g.setInteractive(
                        new Phaser.Geom.Rectangle(-40, -30, 80, 60),
                        Phaser.Geom.Rectangle.Contains
                    );
                    g.on('pointerdown', () => {
                        if (this.input.keyboard.addKey('SHIFT').isDown) {
                            this.toggle(c);
                        } else {
                            this.clearSel();
                            this.sel(c);
                        }
                    });
                    
                    this.hotspots.push(c);
                    this.initialPos.push({x: p.x, y: p.y});
                });
            }

            toggle(h) {
                if (h.getData('sel')) this.desel(h);
                else this.sel(h);
            }

            sel(h) {
                h.setData('sel', true);
                this.selected.push(h);
                const g = h.getData('g');
                g.clear();
                g.lineStyle(5, 0xffff00);
                g.strokeRect(-40, -30, 80, 60);
            }

            desel(h) {
                h.setData('sel', false);
                this.selected = this.selected.filter(s => s !== h);
                const g = h.getData('g');
                g.clear();
                g.lineStyle(3, 0x00ff00);
                g.strokeRect(-40, -30, 80, 60);
            }

            clearSel() {
                [...this.selected].forEach(h => this.desel(h));
            }

            selectAll() {
                this.clearSel();
                this.hotspots.forEach(h => this.sel(h));
                this.log('âœ“ å…¨é€‰ ' + this.hotspots.length + ' ä¸ª');
            }

            selectRandom(n) {
                this.clearSel();
                const shuffled = Phaser.Utils.Array.Shuffle([...this.hotspots]);
                for (let i = 0; i < n && i < shuffled.length; i++) {
                    this.sel(shuffled[i]);
                }
                this.log('âœ“ éšæœºé€‰æ‹© ' + n + ' ä¸ª');
            }

            reset() {
                this.hotspots.forEach((h, i) => {
                    h.x = this.initialPos[i].x;
                    h.y = this.initialPos[i].y;
                });
                this.log('âœ“ å·²é‡ç½®ä½ç½®');
            }

            alignLeft() {
                if (this.selected.length < 2) return this.log('âš ï¸ éœ€è¦è‡³å°‘2ä¸ª', 'warn');
                const minX = Math.min(...this.selected.map(h => h.x));
                this.selected.forEach(h => h.x = minX);
                this.log('âœ“ å·¦å¯¹é½å®Œæˆ');
            }

            alignRight() {
                if (this.selected.length < 2) return this.log('âš ï¸ éœ€è¦è‡³å°‘2ä¸ª', 'warn');
                const maxX = Math.max(...this.selected.map(h => h.x));
                this.selected.forEach(h => h.x = maxX);
                this.log('âœ“ å³å¯¹é½å®Œæˆ');
            }

            alignCenterH() {
                if (this.selected.length < 2) return this.log('âš ï¸ éœ€è¦è‡³å°‘2ä¸ª', 'warn');
                const xs = this.selected.map(h => h.x);
                const cx = (Math.min(...xs) + Math.max(...xs)) / 2;
                this.selected.forEach(h => h.x = cx);
                this.log('âœ“ æ°´å¹³å±…ä¸­å®Œæˆ');
            }

            alignTop() {
                if (this.selected.length < 2) return this.log('âš ï¸ éœ€è¦è‡³å°‘2ä¸ª', 'warn');
                const minY = Math.min(...this.selected.map(h => h.y));
                this.selected.forEach(h => h.y = minY);
                this.log('âœ“ é¡¶éƒ¨å¯¹é½å®Œæˆ');
            }

            alignBottom() {
                if (this.selected.length < 2) return this.log('âš ï¸ éœ€è¦è‡³å°‘2ä¸ª', 'warn');
                const maxY = Math.max(...this.selected.map(h => h.y));
                this.selected.forEach(h => h.y = maxY);
                this.log('âœ“ åº•éƒ¨å¯¹é½å®Œæˆ');
            }

            alignCenterV() {
                if (this.selected.length < 2) return this.log('âš ï¸ éœ€è¦è‡³å°‘2ä¸ª', 'warn');
                const ys = this.selected.map(h => h.y);
                const cy = (Math.min(...ys) + Math.max(...ys)) / 2;
                this.selected.forEach(h => h.y = cy);
                this.log('âœ“ å‚ç›´å±…ä¸­å®Œæˆ');
            }

            distributeH() {
                if (this.selected.length < 3) return this.log('âš ï¸ éœ€è¦è‡³å°‘3ä¸ª', 'warn');
                const sorted = [...this.selected].sort((a, b) => a.x - b.x);
                const minX = sorted[0].x;
                const maxX = sorted[sorted.length - 1].x;
                const spacing = (maxX - minX) / (sorted.length - 1);
                sorted.forEach((h, i) => h.x = minX + spacing * i);
                this.log('âœ“ æ°´å¹³åˆ†å¸ƒå®Œæˆ');
            }

            distributeV() {
                if (this.selected.length < 3) return this.log('âš ï¸ éœ€è¦è‡³å°‘3ä¸ª', 'warn');
                const sorted = [...this.selected].sort((a, b) => a.y - b.y);
                const minY = sorted[0].y;
                const maxY = sorted[sorted.length - 1].y;
                const spacing = (maxY - minY) / (sorted.length - 1);
                sorted.forEach((h, i) => h.y = minY + spacing * i);
                this.log('âœ“ å‚ç›´åˆ†å¸ƒå®Œæˆ');
            }

            alignCanvas() {
                if (this.selected.length === 0) return this.log('âš ï¸ è¯·å…ˆé€‰æ‹©', 'warn');
                const cx = 400, cy = 300;
                if (this.selected.length === 1) {
                    this.selected[0].x = cx;
                    this.selected[0].y = cy;
                } else {
                    const xs = this.selected.map(h => h.x);
                    const ys = this.selected.map(h => h.y);
                    const ox = cx - (Math.min(...xs) + Math.max(...xs)) / 2;
                    const oy = cy - (Math.min(...ys) + Math.max(...ys)) / 2;
                    this.selected.forEach(h => { h.x += ox; h.y += oy; });
                }
                this.log('âœ“ ç”»å¸ƒå±…ä¸­å®Œæˆ');
            }

            runValidation() {
                this.log('ğŸš€ å¼€å§‹éªŒè¯æµ‹è¯•...', 'info');
                this.reset();
                this.selectAll();
                
                const report = this.validator.runFullValidation(this.hotspots);
                this.displayReport(report);
            }

            displayReport(report) {
                const div = document.getElementById('report');
                div.innerHTML = `
                    <div class="metric">
                        <span>æ€»æµ‹è¯•æ•°:</span>
                        <span class="metric-value">${report.summary.total}</span>
                    </div>
                    <div class="metric">
                        <span>é€šè¿‡:</span>
                        <span class="metric-value">${report.summary.passed}</span>
                    </div>
                    <div class="metric">
                        <span>å¤±è´¥:</span>
                        <span style="color:#f44336;">${report.summary.failed}</span>
                    </div>
                    <div class="metric">
                        <span>é€šè¿‡ç‡:</span>
                        <span class="metric-value">${report.summary.passRate}</span>
                    </div>
                    <div class="metric">
                        <span>æ€»è€—æ—¶:</span>
                        <span class="metric-value">${report.summary.totalDuration}</span>
                    </div>
                    <div class="metric">
                        <span>å¹³å‡è€—æ—¶:</span>
                        <span class="metric-value">${report.summary.avgDuration}</span>
                    </div>
                    <div style="margin-top:10px;">
                        ${report.tests.map(t => `
                            <div class="test-result ${t.passed ? '' : 'fail'}">
                                ${t.passed ? 'âœ“' : 'âœ—'} ${t.name}: ${t.duration}ms
                            </div>
                        `).join('')}
                    </div>
                `;
                
                this.log('âœ… éªŒè¯å®Œæˆï¼é€šè¿‡ç‡: ' + report.summary.passRate, 'success');
            }

            showHint() {
                this.add.text(10, 10, [
                    'ğŸ¯ å¯¹é½åˆ†å¸ƒç»ˆææµ‹è¯•',
                    'Shift+ç‚¹å‡»å¤šé€‰ | æ•°å­—é”®1-9æ“ä½œ | Aå…¨é€‰ | Ré‡ç½®'
                ], {
                    fontSize: '12px', color: '#fff',
                    backgroundColor: '#000', padding: { x: 8, y: 5 }
                }).setDepth(100);
            }

            setupKeyboard() {
                this.input.keyboard.on('keydown-ONE', () => this.alignLeft());
                this.input.keyboard.on('keydown-TWO', () => this.alignRight());
                this.input.keyboard.on('keydown-THREE', () => this.alignCenterH());
                this.input.keyboard.on('keydown-FOUR', () => this.alignTop());
                this.input.keyboard.on('keydown-FIVE', () => this.alignBottom());
                this.input.keyboard.on('keydown-SIX', () => this.alignCenterV());
                this.input.keyboard.on('keydown-SEVEN', () => this.distributeH());
                this.input.keyboard.on('keydown-EIGHT', () => this.distributeV());
                this.input.keyboard.on('keydown-NINE', () => this.alignCanvas());
                this.input.keyboard.on('keydown-A', () => this.selectAll());
                this.input.keyboard.on('keydown-R', () => this.reset());
            }

            log(msg, type = 'info') {
                console.log(msg);
            }
        }

        new Phaser.Game({
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game-area',
            scene: AlignFinalScene,
            backgroundColor: '#2d2d2d'
        });
    </script>
</body>
</html>
