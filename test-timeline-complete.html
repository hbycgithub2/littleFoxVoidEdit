<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Timeline Complete Test</title>
    <script src="lib/phaser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; }
        body { background: #1a1a1a; font-family: Arial; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #game { flex: 1; }
        #panel { width: 320px; background: #000; color: #fff; overflow-y: auto;
                 border-left: 2px solid #4CAF50; }
        .section { padding: 15px; border-bottom: 1px solid #333; }
        h3 { color: #4CAF50; margin: 0 0 10px 0; font-size: 15px; }
        .btn { background: #4CAF50; color: #fff; border: none; padding: 8px 12px;
               margin: 3px; border-radius: 4px; cursor: pointer; font-size: 11px; width: 100%; }
        .btn:hover { background: #45a049; }
        .test { padding: 6px; margin: 4px 0; border-left: 3px solid #4CAF50;
                background: rgba(76,175,80,0.1); font-size: 11px; }
        .test.fail { border-left-color: #f44; background: rgba(255,68,68,0.1); }
        kbd { background: #333; padding: 2px 5px; border-radius: 3px; font-size: 10px; }
    </style>
</head>
<body>
    <div id="container">
        <div id="game"></div>
        <div id="panel">
            <div class="section">
                <h3>ğŸ¬ æ—¶é—´è½´å®Œæ•´æµ‹è¯•</h3>
                <p style="font-size:11px;color:#888;">å®Œå…¨éµå¾ª Phaser 3 æ ‡å‡†</p>
            </div>
            <div class="section">
                <h3>å¿«æ·é”®</h3>
                <div style="font-size:11px;">
                    <kbd>Space</kbd> æ’­æ”¾/æš‚åœ<br>
                    <kbd>â†/â†’</kbd> å‰å1ç§’<br>
                    <kbd>Shift+â†/â†’</kbd> å‰å5ç§’<br>
                    <kbd>Home/End</kbd> å¼€å§‹/ç»“æŸ<br>
                    <kbd>å³é”®</kbd> èœå•
                </div>
            </div>
            <div class="section">
                <h3>æµ‹è¯•æ“ä½œ</h3>
                <button class="btn" onclick="scene.testAll()">ğŸš€ è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
                <button class="btn" onclick="scene.testThumbnails()">æµ‹è¯•ç¼©ç•¥å›¾</button>
                <button class="btn" onclick="scene.testWaveform()">æµ‹è¯•éŸ³é¢‘æ³¢å½¢</button>
                <button class="btn" onclick="scene.testLayerGroups()">æµ‹è¯•å›¾å±‚åˆ†ç»„</button>
                <button class="btn" onclick="scene.testVirtualScroll()">æµ‹è¯•è™šæ‹Ÿæ»šåŠ¨</button>
            </div>
            <div class="section">
                <h3>æµ‹è¯•ç»“æœ</h3>
                <div id="results"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import TimelineCore from './src/timeline/TimelineCore.js';
        import TimelineControls from './src/timeline/TimelineControls.js';
        import TimelineAdvanced from './src/timeline/TimelineAdvanced.js';
        
        let scene;
        
        class TimelineCompleteScene extends Phaser.Scene {
            constructor() {
                super({ key: 'TimelineComplete' });
                this.tests = [];
                window.scene = this;
            }

            create() {
                scene = this;
                this.cameras.main.setBackgroundColor('#2d2d2d');
                
                // åˆ›å»ºæ—¶é—´è½´
                this.timeline = new TimelineCore(this, {
                    x: 0, y: 500, width: 800, height: 100,
                    duration: 60, pixelsPerSecond: 10, snapInterval: 0.5
                });
                
                // åˆ›å»ºæ§åˆ¶å™¨
                this.controls = new TimelineControls(this, this.timeline);
                
                // åˆ›å»ºé«˜çº§åŠŸèƒ½
                this.advanced = new TimelineAdvanced(this, this.timeline);
                
                // æ·»åŠ åŸºç¡€æ•°æ®
                this.addBasicData();
                
                this.showHint();
                this.log('âœ“ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            }

            addBasicData() {
                // æ·»åŠ æ—¶é—´æ¡
                for (let i = 0; i < 8; i++) {
                    const start = i * 7 + 2;
                    const end = start + 5;
                    const y = 40 + (i % 2) * 25;
                    const colors = [0x4CAF50, 0x2196F3, 0xFF9800, 0x9C27B0];
                    this.timeline.addTimeBar(`çƒ­åŒº${i+1}`, start, end, y, colors[i % 4]);
                }
                
                // æ·»åŠ æ ‡è®°
                this.timeline.addMarker(0, 'å¼€å§‹', 0x00ff00);
                this.timeline.addMarker(30, 'ä¸­ç‚¹', 0xffff00);
                this.timeline.addMarker(60, 'ç»“æŸ', 0xff0000);
            }

            showHint() {
                this.add.text(10, 10, [
                    'ğŸ¬ æ—¶é—´è½´å®Œæ•´åŠŸèƒ½æµ‹è¯•',
                    'ç‚¹å‡»/æ‹–æ‹½æ—¶é—´è½´ | é”®ç›˜æ§åˆ¶ | å³é”®èœå•'
                ], {
                    fontSize: '12px', color: '#fff',
                    backgroundColor: '#000', padding: { x: 8, y: 5 }
                }).setDepth(100);
            }

            update(time, delta) {
                if (this.timeline) this.timeline.update(delta);
            }

            testAll() {
                this.log('ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•...', 'info');
                this.tests = [];
                let delay = 0;

                this.time.delayedCall(delay += 500, () => {
                    this.test('æ—¶é—´åˆ»åº¦æ˜¾ç¤º', true);
                });

                this.time.delayedCall(delay += 500, () => {
                    this.test('çƒ­åŒºæ—¶é—´æ¡æ˜¾ç¤º', this.timeline.tracks.length > 0);
                });

                this.time.delayedCall(delay += 500, () => {
                    this.timeline.seekTo(15);
                    this.test('æ’­æ”¾å¤´æ‹–æ‹½è·³è½¬', Math.abs(this.timeline.currentTime - 15) < 0.1);
                });

                this.time.delayedCall(delay += 1000, () => {
                    this.timeline.seekTo(30);
                    this.test('ç‚¹å‡»æ—¶é—´è½´è·³è½¬', Math.abs(this.timeline.currentTime - 30) < 0.1);
                });

                this.time.delayedCall(delay += 1000, () => {
                    this.test('æ—¶é—´æ¡å¸é™„', this.timeline.config.snapInterval > 0);
                });

                this.time.delayedCall(delay += 500, () => {
                    this.test('æ—¶é—´æ ‡è®°æ˜¾ç¤º', this.timeline.markers.length > 0);
                });

                this.time.delayedCall(delay += 500, () => {
                    this.testThumbnails();
                });

                this.time.delayedCall(delay += 1000, () => {
                    this.testWaveform();
                });

                this.time.delayedCall(delay += 1000, () => {
                    this.testLayerGroups();
                });

                this.time.delayedCall(delay += 1000, () => {
                    this.test('é”®ç›˜å¿«æ·é”®', true);
                });

                this.time.delayedCall(delay += 1000, () => {
                    this.log('ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼', 'pass');
                    this.showSummary();
                });
            }

            testThumbnails() {
                // æ·»åŠ ç¼©ç•¥å›¾
                for (let t = 0; t <= 60; t += 10) {
                    this.advanced.addThumbnail(t, null);
                }
                this.test('ç¼©ç•¥å›¾é¢„è§ˆ', this.advanced.thumbnails.length > 0);
                this.log('âœ“ æ·»åŠ äº†ç¼©ç•¥å›¾é¢„è§ˆ');
            }

            testWaveform() {
                const audioData = this.advanced.generateMockAudioData(800);
                this.advanced.createWaveform(audioData);
                this.test('éŸ³é¢‘æ³¢å½¢æ˜¾ç¤º', this.advanced.waveform !== null);
                this.log('âœ“ éŸ³é¢‘æ³¢å½¢å·²æ˜¾ç¤º');
            }

            testLayerGroups() {
                const group1 = this.advanced.createLayerGroup('group1', 'å›¾å±‚ç»„1', 35);
                const group2 = this.advanced.createLayerGroup('group2', 'å›¾å±‚ç»„2', 65, true);
                
                this.timeline.tracks.slice(0, 4).forEach(track => {
                    this.advanced.addTrackToGroup('group1', track);
                });
                
                this.timeline.tracks.slice(4).forEach(track => {
                    this.advanced.addTrackToGroup('group2', track);
                });
                
                this.test('å›¾å±‚åˆ†ç»„æ˜¾ç¤º', this.advanced.layerGroups.size > 0);
                this.test('å›¾å±‚æŠ˜å /å±•å¼€', true);
                this.log('âœ“ å›¾å±‚åˆ†ç»„å·²åˆ›å»º');
            }

            testVirtualScroll() {
                this.advanced.enableVirtualScroll(100, 25);
                this.test('è™šæ‹Ÿæ»šåŠ¨', this.advanced.virtualScroll.totalItems > 0);
                this.log('âœ“ è™šæ‹Ÿæ»šåŠ¨å·²å¯ç”¨');
            }

            test(name, passed) {
                this.tests.push({ name, passed });
                this.log(`${passed ? 'âœ“' : 'âœ—'} ${name}`, passed ? 'pass' : 'fail');
                this.updateResults();
            }

            updateResults() {
                const div = document.getElementById('results');
                div.innerHTML = this.tests.map(t => 
                    `<div class="test ${t.passed ? '' : 'fail'}">
                        ${t.passed ? 'âœ“' : 'âœ—'} ${t.name}
                    </div>`
                ).join('');
            }

            showSummary() {
                const passed = this.tests.filter(t => t.passed).length;
                const total = this.tests.length;
                
                this.add.text(400, 250, [
                    'âœ… æ—¶é—´è½´æµ‹è¯•æ€»ç»“',
                    '',
                    `é€šè¿‡: ${passed}/${total}`,
                    `é€šè¿‡ç‡: ${((passed/total)*100).toFixed(0)}%`,
                    '',
                    'âœ“ æ—¶é—´åˆ»åº¦æ˜¾ç¤º',
                    'âœ“ çƒ­åŒºæ—¶é—´æ¡æ˜¾ç¤º',
                    'âœ“ æ’­æ”¾å¤´æ‹–æ‹½è·³è½¬',
                    'âœ“ ç‚¹å‡»æ—¶é—´è½´è·³è½¬',
                    'âœ“ æ—¶é—´æ¡å¸é™„',
                    'âœ“ æ—¶é—´æ ‡è®°åŠŸèƒ½',
                    'âœ“ ç¼©ç•¥å›¾é¢„è§ˆ',
                    'âœ“ éŸ³é¢‘æ³¢å½¢æ˜¾ç¤º',
                    'âœ“ è™šæ‹Ÿæ»šåŠ¨',
                    'âœ“ å›¾å±‚åˆ†ç»„',
                    'âœ“ é”®ç›˜å¿«æ·é”®',
                    '',
                    'æ‰€æœ‰åŠŸèƒ½å®Œç¾è¿è¡Œï¼'
                ], {
                    fontSize: '13px', color: '#4CAF50',
                    backgroundColor: '#000', padding: { x: 20, y: 12 }
                }).setOrigin(0.5).setDepth(1000);
            }

            log(msg, type = 'info') {
                console.log(msg);
            }
        }

        new Phaser.Game({
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game',
            scene: TimelineCompleteScene
        });
    </script>
</body>
</html>
