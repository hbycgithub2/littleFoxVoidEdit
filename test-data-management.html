<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Data Management Test</title>
    <script src="lib/phaser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; }
        body { background: #0a0a0a; font-family: Arial; }
        #app { display: flex; height: 100vh; }
        #game { flex: 1; }
        #panel { width: 380px; background: #000; color: #fff; overflow-y: auto;
                 border-left: 2px solid #4CAF50; }
        .section { padding: 15px; border-bottom: 1px solid #222; }
        h3 { color: #4CAF50; margin: 0 0 10px 0; font-size: 15px; }
        .btn { background: #4CAF50; color: #fff; border: none; padding: 10px;
               margin: 5px 0; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%; }
        .btn:hover { background: #45a049; }
        .btn-primary { background: #2196F3; }
        .btn-primary:hover { background: #1976D2; }
        .test { padding: 8px; margin: 5px 0; border-left: 3px solid #4CAF50;
                background: rgba(76,175,80,0.1); font-size: 11px; }
        .test.fail { border-left-color: #f44; background: rgba(255,68,68,0.1); }
        .metric { display: flex; justify-content: space-between; padding: 5px 0;
                  font-size: 12px; border-bottom: 1px solid #222; }
        .metric-value { color: #4CAF50; font-weight: bold; }
        textarea { width: 100%; height: 150px; background: #1a1a1a; color: #0f0;
                   border: 1px solid #333; padding: 8px; font-family: monospace;
                   font-size: 11px; resize: vertical; }
        .code { background: #1a1a1a; padding: 10px; border-radius: 4px;
                font-family: monospace; font-size: 11px; color: #0f0;
                max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="app">
        <div id="game"></div>
        <div id="panel">
            <div class="section">
                <h3>ğŸ’¾ æ•°æ®ç®¡ç†æµ‹è¯•</h3>
                <p style="font-size:11px;color:#888;">Phaser 3 æ ‡å‡†</p>
            </div>
            
            <div class="section">
                <h3>ğŸ“¤ å¯¼å‡ºæ“ä½œ</h3>
                <button class="btn" onclick="scene.testExport()">å¯¼å‡º JSON</button>
                <button class="btn" onclick="scene.downloadJSON()">ä¸‹è½½ JSON æ–‡ä»¶</button>
            </div>
            
            <div class="section">
                <h3>ğŸ“¥ å¯¼å…¥æ“ä½œ</h3>
                <button class="btn" onclick="scene.testImport()">å¯¼å…¥æµ‹è¯•æ•°æ®</button>
                <input type="file" id="fileInput" accept=".json" style="display:none;">
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    ä»æ–‡ä»¶å¯¼å…¥
                </button>
            </div>
            
            <div class="section">
                <h3>âœ… éªŒè¯æ“ä½œ</h3>
                <button class="btn" onclick="scene.testValidation()">æµ‹è¯•æ•°æ®éªŒè¯</button>
                <button class="btn" onclick="scene.testIntegrity()">æµ‹è¯•å®Œæ•´æ€§æ£€æŸ¥</button>
            </div>
            
            <div class="section">
                <h3>ğŸš€ è‡ªåŠ¨æµ‹è¯•</h3>
                <button class="btn btn-primary" onclick="scene.runFullTest()">
                    è¿è¡Œå®Œæ•´æµ‹è¯•
                </button>
            </div>
            
            <div class="section">
                <h3>ğŸ“Š æ•°æ®é¢„è§ˆ</h3>
                <div id="preview" class="code"></div>
            </div>
            
            <div class="section">
                <h3>ğŸ“ æµ‹è¯•ç»“æœ</h3>
                <div id="results"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import DataManager from './src/data/DataManager.js';
        import DataValidator from './src/data/DataValidator.js';
        
        let scene;
        
        class DataTestScene extends Phaser.Scene {
            constructor() {
                super({ key: 'DataTest' });
                this.tests = [];
                window.scene = this;
            }

            create() {
                scene = this;
                this.cameras.main.setBackgroundColor('#1a1a1a');
                
                // åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨
                this.dataManager = new DataManager(this);
                this.validator = new DataValidator(this.dataManager);
                
                // åˆ›å»ºæµ‹è¯•çƒ­åŒº
                this.createTestHotspots();
                
                // è®¾ç½®æ–‡ä»¶è¾“å…¥
                this.setupFileInput();
                
                this.showHint();
                this.log('âœ“ æ•°æ®ç®¡ç†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            }

            createTestHotspots() {
                this.hotspots = [];
                const colors = [0x4CAF50, 0x2196F3, 0xFF9800, 0x9C27B0, 0xF44336];
                
                for (let i = 0; i < 5; i++) {
                    const container = this.add.container(100 + i * 140, 200);
                    
                    const graphics = this.add.graphics();
                    graphics.lineStyle(3, colors[i]);
                    graphics.strokeRect(-50, -40, 100, 80);
                    container.add(graphics);
                    
                    const text = this.add.text(0, 0, `çƒ­åŒº${i+1}`, {
                        fontSize: '14px', color: '#fff'
                    });
                    text.setOrigin(0.5);
                    container.add(text);
                    
                    container.config = {
                        id: `hotspot_${i}`,
                        type: 'rect',
                        width: 100,
                        height: 80,
                        color: '#' + colors[i].toString(16).padStart(6, '0'),
                        strokeWidth: 3,
                        startTime: i * 5,
                        endTime: (i + 1) * 5,
                        action: { type: 'link', url: `https://example.com/${i}` },
                        metadata: { name: `çƒ­åŒº${i+1}`, description: 'æµ‹è¯•çƒ­åŒº' }
                    };
                    
                    this.hotspots.push(container);
                }
            }

            setupFileInput() {
                const fileInput = document.getElementById('fileInput');
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const result = await this.dataManager.readJSONFile(file);
                            if (result.success) {
                                this.log(`âœ“ å¯¼å…¥æˆåŠŸ: ${result.hotspots.length} ä¸ªçƒ­åŒº`, 'pass');
                                this.updatePreview(result);
                            } else {
                                this.log(`âœ— å¯¼å…¥å¤±è´¥: ${result.error}`, 'fail');
                            }
                        } catch (error) {
                            this.log(`âœ— è¯»å–æ–‡ä»¶å¤±è´¥: ${error.message}`, 'fail');
                        }
                    }
                });
            }

            showHint() {
                this.add.text(20, 20, [
                    'ğŸ’¾ æ•°æ®ç®¡ç†å®Œæ•´æµ‹è¯•',
                    'æµ‹è¯•å¯¼å‡º/å¯¼å…¥ã€éªŒè¯ã€å®Œæ•´æ€§æ£€æŸ¥'
                ], {
                    fontSize: '12px', color: '#fff',
                    backgroundColor: '#000', padding: { x: 8, y: 5 }
                }).setDepth(100);
            }

            testExport() {
                const result = this.dataManager.exportJSON(this.hotspots, {
                    title: 'æµ‹è¯•é¡¹ç›®',
                    author: 'æµ‹è¯•ç”¨æˆ·',
                    description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é¡¹ç›®'
                });
                
                if (result.success) {
                    this.log(`âœ“ å¯¼å‡ºæˆåŠŸ: ${result.hotspotCount} ä¸ªçƒ­åŒº, ${result.size} å­—èŠ‚`, 'pass');
                    this.updatePreview(JSON.parse(result.data));
                    this.lastExportData = result.data;
                } else {
                    this.log(`âœ— å¯¼å‡ºå¤±è´¥: ${result.error}`, 'fail');
                }
            }

            downloadJSON() {
                if (!this.lastExportData) {
                    this.testExport();
                }
                
                if (this.lastExportData) {
                    const success = this.dataManager.downloadJSON(
                        this.lastExportData,
                        `hotspots_${Date.now()}.json`
                    );
                    
                    if (success) {
                        this.log('âœ“ æ–‡ä»¶ä¸‹è½½æˆåŠŸ', 'pass');
                    } else {
                        this.log('âœ— æ–‡ä»¶ä¸‹è½½å¤±è´¥', 'fail');
                    }
                }
            }

            testImport() {
                // å…ˆå¯¼å‡º
                const exportResult = this.dataManager.exportJSON(this.hotspots);
                
                if (exportResult.success) {
                    // å†å¯¼å…¥
                    const importResult = this.dataManager.importJSON(exportResult.data);
                    
                    if (importResult.success) {
                        this.log(`âœ“ å¯¼å…¥æˆåŠŸ: ${importResult.hotspots.length} ä¸ªçƒ­åŒº`, 'pass');
                        this.updatePreview(importResult);
                    } else {
                        this.log(`âœ— å¯¼å…¥å¤±è´¥: ${importResult.error}`, 'fail');
                    }
                }
            }

            testValidation() {
                // æµ‹è¯•æœ‰æ•ˆæ•°æ®
                const validData = {
                    version: '1.0.0',
                    hotspots: [
                        { id: 'h1', type: 'rect', x: 100, y: 100, width: 100, height: 80 }
                    ],
                    metadata: {}
                };
                
                const validResult = this.dataManager.validateImportData(validData);
                
                // æµ‹è¯•æ— æ•ˆæ•°æ®
                const invalidData = { invalid: true };
                const invalidResult = this.dataManager.validateImportData(invalidData);
                
                if (validResult && !invalidResult) {
                    this.log('âœ“ æ•°æ®éªŒè¯åŠŸèƒ½æ­£å¸¸', 'pass');
                } else {
                    this.log('âœ— æ•°æ®éªŒè¯åŠŸèƒ½å¼‚å¸¸', 'fail');
                }
                
                // æ˜¾ç¤ºé”™è¯¯
                const errors = this.dataManager.getErrors();
                if (errors.length > 0) {
                    this.log(`å‘ç° ${errors.length} ä¸ªéªŒè¯é”™è¯¯`, 'info');
                }
            }

            testIntegrity() {
                const exportResult = this.dataManager.exportJSON(this.hotspots);
                
                if (exportResult.success) {
                    const data = JSON.parse(exportResult.data);
                    const integrity = this.dataManager.checkDataIntegrity(data);
                    
                    if (integrity.valid) {
                        this.log('âœ“ æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡', 'pass');
                    } else {
                        this.log('âœ— æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥', 'fail');
                    }
                    
                    this.updatePreview({
                        integrityCheck: integrity.checks,
                        errors: integrity.errors
                    });
                }
            }

            async runFullTest() {
                this.log('ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•...', 'info');
                this.tests = [];
                
                const report = await this.validator.runFullValidation();
                
                this.displayReport(report);
                this.showSummary(report);
            }

            displayReport(report) {
                const div = document.getElementById('results');
                div.innerHTML = report.tests.map(t => 
                    `<div class="test ${t.passed ? '' : 'fail'}">
                        ${t.passed ? 'âœ“' : 'âœ—'} ${t.name} (${t.duration}ms)
                    </div>`
                ).join('');
                
                this.log(`æµ‹è¯•å®Œæˆ: ${report.summary.passRate} é€šè¿‡ç‡`, 'info');
            }

            showSummary(report) {
                const passed = report.summary.passed;
                const total = report.summary.total;
                
                this.add.text(400, 300, [
                    'âœ… æ•°æ®ç®¡ç†æµ‹è¯•æ€»ç»“',
                    '',
                    `é€šè¿‡: ${passed}/${total}`,
                    `é€šè¿‡ç‡: ${report.summary.passRate}`,
                    `æ€»è€—æ—¶: ${report.summary.totalDuration}`,
                    '',
                    'âœ“ å¯¼å‡º JSON',
                    'âœ“ å¯¼å…¥ JSON',
                    'âœ“ æ•°æ®éªŒè¯',
                    'âœ“ é”™è¯¯å¤„ç†',
                    'âœ“ å®Œæ•´æ€§æ£€æŸ¥',
                    '',
                    passed === total ? 'ğŸ‰ å®Œç¾é€šè¿‡ï¼' : 'âš ï¸ éƒ¨åˆ†åŠŸèƒ½éœ€ä¼˜åŒ–'
                ], {
                    fontSize: '13px',
                    color: passed === total ? '#4CAF50' : '#FF9800',
                    backgroundColor: '#000',
                    padding: { x: 20, y: 12 }
                }).setOrigin(0.5).setDepth(1000);
            }

            updatePreview(data) {
                const div = document.getElementById('preview');
                div.textContent = JSON.stringify(data, null, 2).substring(0, 500) + '...';
            }

            log(msg, type = 'info') {
                console.log(msg);
            }
        }

        new Phaser.Game({
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game',
            scene: DataTestScene
        });
    </script>
</body>
</html>
