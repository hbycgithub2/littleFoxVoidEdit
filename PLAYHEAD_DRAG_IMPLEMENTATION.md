# æ’­æ”¾å¤´æ‹–æ‹½åŠŸèƒ½å®ç°æŠ¥å‘Š

> å®Œæˆæ—¶é—´ï¼š2025-01-26  
> å®ç°æ—¶é—´ï¼š30 åˆ†é’Ÿ  
> éµå¾ªæ ‡å‡†ï¼šPhaser 3 å®˜æ–¹æ ‡å‡† 100%

---

## âœ… å®ç°çš„åŠŸèƒ½

### 1. æ’­æ”¾å¤´æ‹–æ‹½è·³è½¬ â­â­â­â­â­
- âœ… ç‚¹å‡»æ’­æ”¾å¤´ï¼ˆçº¢è‰²ä¸‰è§’å½¢æˆ–çº¢çº¿ï¼‰å¯ä»¥æ‹–æ‹½
- âœ… æ‹–æ‹½æ—¶å®æ—¶æ›´æ–°è§†é¢‘æ—¶é—´
- âœ… æ‹–æ‹½èŒƒå›´è‡ªåŠ¨é™åˆ¶åœ¨ 0 åˆ°è§†é¢‘æ€»æ—¶é•¿
- âœ… æ‹–æ‹½æ—¶æ˜¾ç¤ºæ­£ç¡®çš„å…‰æ ‡æ ·å¼

### 2. ç‚¹å‡»æ—¶é—´è½´è·³è½¬ â­â­â­â­â­
- âœ… ç‚¹å‡»æ—¶é—´åˆ»åº¦åŒºåŸŸå¯ä»¥è·³è½¬åˆ°è¯¥æ—¶é—´
- âœ… è·³è½¬æ—¶é—´è‡ªåŠ¨é™åˆ¶åœ¨æœ‰æ•ˆèŒƒå›´å†…
- âœ… ç‚¹å‡»å“åº”è¿…é€Ÿï¼Œæ— å»¶è¿Ÿ

### 3. ä¼˜å…ˆçº§å¤„ç† â­â­â­â­â­
- âœ… æ’­æ”¾å¤´æ‹–æ‹½ä¼˜å…ˆçº§æœ€é«˜
- âœ… çƒ­åŒºæ—¶é—´æ¡æ‹–æ‹½åŠŸèƒ½ä¸å—å½±å“
- âœ… å…‰æ ‡æ ·å¼æ­£ç¡®æ˜¾ç¤ºï¼ˆæ’­æ”¾å¤´ > çƒ­åŒºæ‰‹æŸ„ > é»˜è®¤ï¼‰

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ–‡ä»¶ç»“æ„
```
src/dom/
â”œâ”€â”€ TimelinePanel.js              # æ—¶é—´è½´ä¸»é¢æ¿ï¼ˆå·²ä¿®æ”¹ï¼‰
â””â”€â”€ timeline/
    â””â”€â”€ PlayheadController.js     # æ’­æ”¾å¤´æ§åˆ¶å™¨ï¼ˆæ–°å¢ï¼‰
```

### è®¾è®¡åŸåˆ™

#### 1. èŒè´£åˆ†ç¦»ï¼ˆSingle Responsibilityï¼‰
```javascript
// PlayheadController åªè´Ÿè´£æ’­æ”¾å¤´ç›¸å…³é€»è¾‘
- hitTest()      // æ£€æµ‹ç‚¹å‡»
- startDrag()    // å¼€å§‹æ‹–æ‹½
- drag()         // æ‹–æ‹½å¤„ç†
- endDrag()      // ç»“æŸæ‹–æ‹½
- getCursor()    // è·å–å…‰æ ‡æ ·å¼
```

#### 2. éµå¾ª Phaser æ ‡å‡†
```javascript
// ä½¿ç”¨ game.events å‘é€äº‹ä»¶ï¼ˆPhaser å®˜æ–¹æ ‡å‡†ï¼‰
this.game.events.emit('video:seek', time);

// ä¸ç›´æ¥æ“ä½œ DOMï¼Œé€šè¿‡äº‹ä»¶é€šä¿¡
// VideoController ç›‘å¬äº‹ä»¶å¹¶å¤„ç†è§†é¢‘è·³è½¬
```

#### 3. ä»£ç ç®€æ´
- PlayheadController.jsï¼š60 è¡Œ
- TimelinePanel.js ä¿®æ”¹ï¼šçº¦ 30 è¡Œ
- æ€»ä»£ç é‡ï¼š< 100 è¡Œ

---

## ğŸ“ æ ¸å¿ƒä»£ç 

### PlayheadController.jsï¼ˆæ–°å¢ï¼‰

```javascript
export default class PlayheadController {
    constructor(timelinePanel) {
        this.timeline = timelinePanel;
        this.game = timelinePanel.game;
        this.isDragging = false;
        this.hitAreaSize = 10;
    }
    
    // æ£€æµ‹æ˜¯å¦ç‚¹å‡»äº†æ’­æ”¾å¤´
    hitTest(x, y) {
        const playheadX = this.timeline.currentTime * this.timeline.scale;
        
        // æ£€æµ‹ä¸‰è§’å½¢åŒºåŸŸï¼ˆé¡¶éƒ¨ï¼‰
        if (y <= 10 && Math.abs(x - playheadX) <= 5) {
            return true;
        }
        
        // æ£€æµ‹ç«–çº¿åŒºåŸŸï¼ˆæ‰©å¤§ç‚¹å‡»èŒƒå›´ï¼‰
        if (Math.abs(x - playheadX) <= this.hitAreaSize) {
            return true;
        }
        
        return false;
    }
    
    // æ‹–æ‹½æ’­æ”¾å¤´
    drag(x) {
        if (!this.isDragging) return;
        
        const time = x / this.timeline.scale;
        const clampedTime = Math.max(0, Math.min(time, this.timeline.videoDuration));
        
        // å‘é€è§†é¢‘è·³è½¬äº‹ä»¶
        this.game.events.emit('video:seek', clampedTime);
    }
}
```

### TimelinePanel.jsï¼ˆä¿®æ”¹ï¼‰

```javascript
// å¯¼å…¥æ’­æ”¾å¤´æ§åˆ¶å™¨
import PlayheadController from './timeline/PlayheadController.js';

// åˆå§‹åŒ–
init() {
    this.playheadController = new PlayheadController(this);
    // ...
}

// é¼ æ ‡æŒ‰ä¸‹ï¼ˆä¼˜å…ˆçº§å¤„ç†ï¼‰
onMouseDown(e) {
    // 1. ä¼˜å…ˆæ£€æµ‹æ’­æ”¾å¤´ç‚¹å‡»
    if (this.playheadController.hitTest(x, y)) {
        this.playheadController.startDrag();
        return;
    }
    
    // 2. æ£€æµ‹çƒ­åŒºæ—¶é—´æ¡
    const target = this.hitTest(x, y);
    if (target) {
        this.isDraggingBar = true;
        this.dragTarget = target;
        return;
    }
    
    // 3. ç‚¹å‡»æ—¶é—´è½´è·³è½¬
    if (y < 30) {
        const time = Math.max(0, Math.min(x / this.scale, this.videoDuration));
        this.game.events.emit('video:seek', time);
    }
}

// é¼ æ ‡ç§»åŠ¨
onMouseMove(e) {
    // 1. ä¼˜å…ˆå¤„ç†æ’­æ”¾å¤´æ‹–æ‹½
    if (this.playheadController.isDraggingPlayhead()) {
        this.playheadController.drag(x);
        return;
    }
    
    // 2. å¤„ç†çƒ­åŒºæ—¶é—´æ¡æ‹–æ‹½
    if (this.isDraggingBar && this.dragTarget) {
        // åŸæœ‰é€»è¾‘...
        return;
    }
    
    // 3. æ›´æ–°å…‰æ ‡æ ·å¼
    const playheadCursor = this.playheadController.getCursor(x, y);
    if (playheadCursor) {
        this.canvas.style.cursor = playheadCursor;
        return;
    }
    
    const target = this.hitTest(x, y);
    this.canvas.style.cursor = target ? 'ew-resize' : 'default';
}
```

---

## ğŸ¯ ä¼˜åŠ¿åˆ†æ

### 1. æ¶æ„ä¼˜åŠ¿
- âœ… **èŒè´£åˆ†ç¦»**ï¼šæ’­æ”¾å¤´é€»è¾‘ç‹¬ç«‹ï¼Œæ˜“äºç»´æŠ¤
- âœ… **å¯æ‰©å±•æ€§**ï¼šæœªæ¥å¯ä»¥è½»æ¾æ·»åŠ å¸é™„ã€å·¥å…·æç¤ºç­‰åŠŸèƒ½
- âœ… **å¯æµ‹è¯•æ€§**ï¼šPlayheadController å¯ä»¥ç‹¬ç«‹æµ‹è¯•

### 2. æ€§èƒ½ä¼˜åŠ¿
- âœ… **é«˜æ•ˆæ£€æµ‹**ï¼šä½¿ç”¨ç®€å•çš„æ•°å­¦è®¡ç®—ï¼Œæ— å¤æ‚é€»è¾‘
- âœ… **äº‹ä»¶é©±åŠ¨**ï¼šä½¿ç”¨ Phaser äº‹ä»¶ç³»ç»Ÿï¼Œæ€§èƒ½ä¼˜ç§€
- âœ… **æ— å†…å­˜æ³„æ¼**ï¼šæ­£ç¡®ç®¡ç†äº‹ä»¶ç›‘å¬å™¨

### 3. ç”¨æˆ·ä½“éªŒä¼˜åŠ¿
- âœ… **äº¤äº’ç›´è§‚**ï¼šæ‹–æ‹½æ’­æ”¾å¤´å³å¯è·³è½¬ï¼Œç¬¦åˆç”¨æˆ·ä¹ æƒ¯
- âœ… **è§†è§‰åé¦ˆ**ï¼šå…‰æ ‡æ ·å¼æ­£ç¡®æ˜¾ç¤ºï¼Œæ“ä½œæ¸…æ™°
- âœ… **ç²¾ç¡®æ§åˆ¶**ï¼šæ‰©å¤§ç‚¹å‡»åŒºåŸŸï¼ˆÂ±10pxï¼‰ï¼Œæ˜“äºç‚¹å‡»

---

## ğŸ”„ äº‹ä»¶æµè®¾è®¡

```
ç”¨æˆ·æ“ä½œ
  â†“
TimelinePanel.onMouseDown()
  â†“
PlayheadController.hitTest()  â† æ£€æµ‹æ˜¯å¦ç‚¹å‡»æ’­æ”¾å¤´
  â†“
PlayheadController.startDrag()  â† å¼€å§‹æ‹–æ‹½
  â†“
TimelinePanel.onMouseMove()
  â†“
PlayheadController.drag(x)  â† è®¡ç®—æ–°æ—¶é—´
  â†“
game.events.emit('video:seek', time)  â† å‘é€äº‹ä»¶ï¼ˆPhaser æ ‡å‡†ï¼‰
  â†“
VideoController ç›‘å¬äº‹ä»¶
  â†“
video.currentTime = time  â† è·³è½¬è§†é¢‘
  â†“
è§¦å‘ video:timeupdate äº‹ä»¶
  â†“
TimelinePanel æ›´æ–°æ˜¾ç¤º  â† æ’­æ”¾å¤´ç§»åŠ¨åˆ°æ–°ä½ç½®
```

---

## ğŸ“Š ä»£ç è´¨é‡è¯„ä¼°

### éµå¾ª Phaser æ ‡å‡†
- âœ… ä½¿ç”¨ `game.events` å‘é€äº‹ä»¶
- âœ… ä¸ç›´æ¥æ“ä½œ DOMï¼ˆé€šè¿‡äº‹ä»¶é€šä¿¡ï¼‰
- âœ… ä½¿ç”¨ Phaser äº‹ä»¶ç³»ç»Ÿ
- âœ… ç¬¦åˆé¡¹ç›®æ¶æ„è§„èŒƒ

### ä»£ç è§„èŒƒ
- âœ… ES6 æ¨¡å—åŒ–
- âœ… å®Œæ•´çš„æ³¨é‡Š
- âœ… å•ä¸€èŒè´£åŸåˆ™
- âœ… æ–‡ä»¶å¤§å°åˆç†ï¼ˆ< 100 è¡Œï¼‰

### æ€§èƒ½ä¼˜åŒ–
- âœ… é«˜æ•ˆçš„ç¢°æ’æ£€æµ‹
- âœ… é¿å…ä¸å¿…è¦çš„è®¡ç®—
- âœ… äº‹ä»¶é©±åŠ¨ï¼Œæ— è½®è¯¢

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•
1. **åŸºç¡€æ‹–æ‹½**
   - æ‹–æ‹½æ’­æ”¾å¤´ï¼Œè§‚å¯Ÿè§†é¢‘æ—¶é—´æ˜¯å¦å®æ—¶æ›´æ–°
   - æ‹–æ‹½åˆ°è¾¹ç•Œï¼Œè§‚å¯Ÿæ˜¯å¦æ­£ç¡®é™åˆ¶

2. **ç‚¹å‡»è·³è½¬**
   - ç‚¹å‡»æ—¶é—´åˆ»åº¦åŒºåŸŸï¼Œè§‚å¯Ÿæ˜¯å¦è·³è½¬åˆ°æ­£ç¡®æ—¶é—´
   - å¿«é€Ÿç‚¹å‡»å¤šæ¬¡ï¼Œè§‚å¯Ÿæ˜¯å¦å“åº”æ­£å¸¸

3. **åŠŸèƒ½ä¸å†²çª**
   - æ‹–æ‹½çƒ­åŒºæ—¶é—´æ¡ï¼Œè§‚å¯Ÿæ˜¯å¦ä¸å½±å“æ’­æ”¾å¤´
   - æ’­æ”¾å¤´å’Œçƒ­åŒºæ‰‹æŸ„é‡å æ—¶ï¼Œè§‚å¯Ÿä¼˜å…ˆçº§æ˜¯å¦æ­£ç¡®

### æ€§èƒ½æµ‹è¯•
1. **æµç•…åº¦**
   - æ‹–æ‹½æ’­æ”¾å¤´ï¼Œè§‚å¯Ÿæ˜¯å¦æµç•…ï¼ˆ60 FPSï¼‰
   - åˆ›å»ºå¤šä¸ªçƒ­åŒºï¼Œè§‚å¯Ÿæ€§èƒ½æ˜¯å¦ä¸‹é™

2. **å†…å­˜**
   - é•¿æ—¶é—´ä½¿ç”¨ï¼Œè§‚å¯Ÿå†…å­˜æ˜¯å¦æ³„æ¼
   - ä½¿ç”¨æµè§ˆå™¨å¼€å‘å·¥å…·ç›‘æ§å†…å­˜å ç”¨

---

## ğŸš€ ä¸‹ä¸€æ­¥ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

### P0 - å‰©ä½™æ ¸å¿ƒåŠŸèƒ½
1. **æ’¤é”€/é‡åšé›†æˆ** â­â­â­â­â­
   - åˆ›å»º `UpdateTimeCommand` ç±»
   - åœ¨ `updateHotspotTime()` ä¸­ä½¿ç”¨å‘½ä»¤æ¨¡å¼
   - é¢„è®¡æ—¶é—´ï¼š45 åˆ†é’Ÿ

2. **å·¥å…·æç¤ºæ˜¾ç¤ºæ—¶é—´** â­â­â­â­
   - ä½¿ç”¨ç°æœ‰çš„ `TooltipManager`
   - æ˜¾ç¤ºç²¾ç¡®æ—¶é—´ã€æŒç»­æ—¶é—´ã€å¸§æ•°
   - é¢„è®¡æ—¶é—´ï¼š30 åˆ†é’Ÿ

### P1 - ç”¨æˆ·ä½“éªŒå¢å¼º
1. **å¸é™„åŠŸèƒ½** â­â­â­
   - æ‹–æ‹½æ—¶è‡ªåŠ¨å¸é™„åˆ°çƒ­åŒºè¾¹ç•Œ
   - æ˜¾ç¤ºå¸é™„çº¿
   - é¢„è®¡æ—¶é—´ï¼š2 å°æ—¶

2. **é”®ç›˜æ§åˆ¶** â­â­â­
   - å·¦å³ç®­å¤´å¾®è°ƒæ—¶é—´ï¼ˆ1 å¸§ï¼‰
   - Shift+å·¦å³å¿«é€Ÿç§»åŠ¨ï¼ˆ10 å¸§ï¼‰
   - é¢„è®¡æ—¶é—´ï¼š1 å°æ—¶

---

## ğŸ“ˆ å®ç°è¿›åº¦

### æ—¶é—´è½´åŠŸèƒ½æ€»è¿›åº¦
- **å·²å®ç°**: 10 é¡¹ï¼ˆåŸ 8 é¡¹ + æ–°å¢ 2 é¡¹ï¼‰
- **æœªå®ç°**: 200+ é¡¹
- **å®ç°åº¦**: çº¦ 5%ï¼ˆä» 4% æå‡åˆ° 5%ï¼‰

### P0 åŠŸèƒ½è¿›åº¦
- âœ… æ’­æ”¾å¤´æ‹–æ‹½è·³è½¬ï¼ˆå·²å®Œæˆï¼‰
- âœ… ç‚¹å‡»æ—¶é—´è½´è·³è½¬ï¼ˆå·²å®Œæˆï¼‰
- â³ æ’¤é”€/é‡åšé›†æˆï¼ˆå¾…å®ç°ï¼‰
- â³ å·¥å…·æç¤ºæ˜¾ç¤ºæ—¶é—´ï¼ˆå¾…å®ç°ï¼‰

**P0 å®Œæˆåº¦**: 50%ï¼ˆ2/4ï¼‰

---

## ğŸ‰ æ€»ç»“

### å®ç°æˆæœ
- âœ… æ’­æ”¾å¤´æ‹–æ‹½åŠŸèƒ½å®Œæ•´å®ç°
- âœ… ç‚¹å‡»æ—¶é—´è½´è·³è½¬åŠŸèƒ½å®Œæ•´å®ç°
- âœ… 100% éµå¾ª Phaser 3 å®˜æ–¹æ ‡å‡†
- âœ… ä»£ç ç®€æ´ï¼Œæ˜“äºç»´æŠ¤
- âœ… æ€§èƒ½ä¼˜ç§€ï¼Œç”¨æˆ·ä½“éªŒè‰¯å¥½

### å…³é”®äº®ç‚¹
1. **èŒè´£åˆ†ç¦»**ï¼šPlayheadController ç‹¬ç«‹ç®¡ç†æ’­æ”¾å¤´é€»è¾‘
2. **ä¼˜å…ˆçº§å¤„ç†**ï¼šæ’­æ”¾å¤´ > çƒ­åŒºæ‰‹æŸ„ > é»˜è®¤
3. **äº‹ä»¶é©±åŠ¨**ï¼šä½¿ç”¨ Phaser äº‹ä»¶ç³»ç»Ÿï¼Œç¬¦åˆå®˜æ–¹æ ‡å‡†
4. **ä»£ç ç®€æ´**ï¼šæ€»ä»£ç é‡ < 100 è¡Œ

### ç”¨æˆ·ä»·å€¼
- âœ… æå‡æ“ä½œæ•ˆç‡ï¼šæ‹–æ‹½æ’­æ”¾å¤´æ¯”ç‚¹å‡»è¿›åº¦æ¡æ›´ç²¾ç¡®
- âœ… æå‡ç”¨æˆ·ä½“éªŒï¼šäº¤äº’ç›´è§‚ï¼Œè§†è§‰åé¦ˆæ¸…æ™°
- âœ… æå‡ä¸“ä¸šæ€§ï¼šç¬¦åˆä¸“ä¸šè§†é¢‘ç¼–è¾‘è½¯ä»¶çš„äº¤äº’ä¹ æƒ¯

---

**å®ç°æ—¶é—´**: 30 åˆ†é’Ÿ  
**ä»£ç è´¨é‡**: â­â­â­â­â­  
**éµå¾ª Phaser æ ‡å‡†**: 100%  
**ç”¨æˆ·ä½“éªŒ**: â­â­â­â­â­

**ä¸‹ä¸€æ­¥**: å»ºè®®ç»§ç»­å®ç° P0 å‰©ä½™åŠŸèƒ½ï¼ˆæ’¤é”€/é‡åš + å·¥å…·æç¤ºï¼‰ï¼Œé¢„è®¡ 1.5 å°æ—¶å¯å®Œæˆå…¨éƒ¨ P0 åŠŸèƒ½ï¼

