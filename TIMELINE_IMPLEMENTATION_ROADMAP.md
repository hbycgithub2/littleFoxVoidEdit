# 时间轴功能实现路线图

> 基于 Phaser 3 官方标准的完整时间轴功能实现计划

## 📊 当前状态

- **已实现功能**: 8项
- **未实现功能**: 200+项
- **实现度**: 约4%
- **代码文件**: `src/dom/TimelinePanel.js`

---

## ✅ 已实现的功能

### 基础显示
- [x] 时间刻度线和标签
- [x] 热区时间条（带颜色）
- [x] 当前时间红线指示器
- [x] 热区名称显示

### 基础交互
- [x] 拖拽手柄调整startTime/endTime
- [x] 鼠标滚轮缩放时间轴
- [x] 鼠标悬停光标变化

### 数据同步
- [x] 监听video:timeupdate更新当前时间
- [x] 监听hotspot:added/removed刷新显示
- [x] 拖拽结束后同步到Scene

---

## 🎯 实现优先级和执行计划

### P0 - 紧急修复（核心功能）

#### 1. 播放头拖拽跳转 ⭐⭐⭐⭐⭐
**目标**: 拖拽红色播放头可以跳转视频时间

**实现步骤**:
1. 在`drawCurrentTimeIndicator()`中给播放头添加可拖拽区域
2. 在`onMouseDown()`中检测是否点击播放头
3. 在`onMouseMove()`中拖拽时更新视频时间
4. 发送`video:seek`事件跳转视频

**涉及文件**: `src/dom/TimelinePanel.js`

**预计时间**: 30分钟

---

#### 2. 点击时间轴跳转 ⭐⭐⭐⭐⭐
**目标**: 点击时间刻度区域可以跳转到该时间

**实现步骤**:
1. 在`onMouseDown()`中取消注释时间轴点击代码
2. 优化点击检测，避免与视频进度条冲突
3. 添加视觉反馈（点击时高亮）

**涉及文件**: `src/dom/TimelinePanel.js`

**预计时间**: 15分钟

---

#### 3. 撤销/重做集成 ⭐⭐⭐⭐⭐
**目标**: 时间调整支持撤销/重做

**实现步骤**:
1. 创建`UpdateTimeCommand`类
2. 在`updateHotspotTime()`中使用命令模式
3. 集成到`CommandManager`

**涉及文件**: 
- `src/core/CommandManager.js`
- `src/dom/TimelinePanel.js`

**预计时间**: 45分钟

---

#### 4. 工具提示显示时间 ⭐⭐⭐⭐
**目标**: 悬停时显示精确时间和持续时间

**实现步骤**:
1. 在`onMouseMove()`中检测悬停位置
2. 创建工具提示元素
3. 显示时间、持续时间、帧数等信息
4. 使用`TooltipManager`统一管理

**涉及文件**: 
- `src/dom/TimelinePanel.js`
- `src/dom/TooltipManager.js`

**预计时间**: 30分钟

---

### P1 - 高优先级（用户体验）

#### 5. 图层分组显示 ⭐⭐⭐⭐
**目标**: 按图层分组显示热区时间条

**实现步骤**:
1. 修改`drawHotspotBars()`按图层分组
2. 添加图层折叠/展开功能
3. 添加图层标题显示
4. 图层颜色标识

**涉及文件**: 
- `src/dom/TimelinePanel.js`
- `src/core/LayerManager.js`

**预计时间**: 2小时

---

#### 6. 多选时间条 ⭐⭐⭐⭐
**目标**: 支持选择多个时间条进行批量操作

**实现步骤**:
1. 添加选择状态管理
2. Ctrl+点击多选
3. 框选功能
4. 选中时高亮显示
5. 批量移动/删除

**涉及文件**: `src/dom/TimelinePanel.js`

**预计时间**: 3小时

---

#### 7. 拖拽整个时间条 ⭐⭐⭐⭐
**目标**: 拖拽时间条中间部分可以整体移动

**实现步骤**:
1. 在`hitTest()`中检测时间条中间区域
2. 在`onMouseMove()`中同时调整startTime和endTime
3. 保持持续时间不变

**涉及文件**: `src/dom/TimelinePanel.js`

**预计时间**: 1小时

---

#### 8. 键盘快捷键 ⭐⭐⭐⭐
**目标**: 支持键盘快捷键操作

**快捷键列表**:
- `←/→` - 微调时间（1帧）
- `Shift+←/→` - 快速移动（10帧）
- `Home` - 跳转到开始
- `End` - 跳转到结束
- `Space` - 播放/暂停
- `[/]` - 设置入点/出点
- `M` - 添加标记

**实现步骤**:
1. 在`KeyboardManager`中注册快捷键
2. 在`TimelinePanel`中处理快捷键事件
3. 添加快捷键提示

**涉及文件**: 
- `src/utils/KeyboardManager.js`
- `src/dom/TimelinePanel.js`

**预计时间**: 2小时

---

#### 9. 右键菜单 ⭐⭐⭐
**目标**: 右键时间条显示上下文菜单

**菜单项**:
- 删除
- 复制
- 剪切
- 分割
- 属性

**实现步骤**:
1. 创建`ContextMenu`组件
2. 在`canvas`上监听`contextmenu`事件
3. 根据点击位置显示不同菜单

**涉及文件**: 
- `src/dom/TimelinePanel.js`
- `src/dom/ContextMenu.js` (新建)

**预计时间**: 2小时

---

#### 10. 时间条吸附 ⭐⭐⭐
**目标**: 拖拽时自动吸附到网格或其他时间条

**实现步骤**:
1. 添加吸附开关
2. 计算吸附点（网格、其他时间条边缘）
3. 在拖拽时自动对齐
4. 显示吸附线

**涉及文件**: `src/dom/TimelinePanel.js`

**预计时间**: 2小时

---

### P2 - 中优先级（增强功能）

#### 11. 时间标记系统 ⭐⭐⭐
**目标**: 添加时间标记点

**功能**:
- 添加/删除标记
- 标记命名
- 跳转到标记
- 标记颜色分类
- 导出/导入标记

**实现步骤**:
1. 创建`Marker`数据结构
2. 在时间轴上绘制标记
3. 添加标记管理UI
4. 实现标记交互

**涉及文件**: 
- `src/dom/TimelinePanel.js`
- `src/core/MarkerManager.js` (新建)

**预计时间**: 4小时

---

#### 12. 虚拟滚动优化 ⭐⭐⭐
**目标**: 大量热区时性能优化

**实现步骤**:
1. 计算可见区域
2. 只渲染可见的时间条
3. 使用对象池复用
4. 添加滚动条

**涉及文件**: `src/dom/TimelinePanel.js`

**预计时间**: 3小时

---

#### 13. 缩略图预览 ⭐⭐⭐
**目标**: 时间条显示热区缩略图

**实现步骤**:
1. 捕获热区截图
2. 缩放到缩略图尺寸
3. 在时间条上绘制
4. 缓存缩略图

**涉及文件**: `src/dom/TimelinePanel.js`

**预计时间**: 3小时

---

#### 14. 时间区域选择 ⭐⭐⭐
**目标**: 选择时间范围进行操作

**功能**:
- 拖拽选择区域
- 循环播放区域
- 导出区域
- 删除区域内热区

**实现步骤**:
1. 添加区域选择交互
2. 绘制选择区域高亮
3. 实现区域操作功能

**涉及文件**: `src/dom/TimelinePanel.js`

**预计时间**: 3小时

---

#### 15. 导出JSON ⭐⭐
**目标**: 导出时间轴数据

**实现步骤**:
1. 收集所有时间数据
2. 格式化为JSON
3. 下载文件
4. 支持导入

**涉及文件**: 
- `src/dom/TimelinePanel.js`
- `src/data/DataManager.js`

**预计时间**: 1小时

---

### P3 - 低优先级（高级功能）

#### 16. 音频波形显示 ⭐⭐
**目标**: 显示音频波形

**实现步骤**:
1. 使用Web Audio API提取波形
2. 绘制波形图
3. 同步到时间轴

**涉及文件**: 
- `src/dom/TimelinePanel.js`
- `src/audio/WaveformRenderer.js` (新建)

**预计时间**: 6小时

---

#### 17. 视频帧预览 ⭐⭐
**目标**: 悬停显示视频帧

**实现步骤**:
1. 捕获视频帧
2. 显示预览窗口
3. 缓存帧数据

**涉及文件**: `src/dom/TimelinePanel.js`

**预计时间**: 4小时

---

#### 18. 协作功能 ⭐
**目标**: 多用户实时编辑

**实现步骤**:
1. WebSocket连接
2. 操作同步
3. 冲突解决
4. 用户光标显示

**涉及文件**: 
- `src/network/CollaborationManager.js` (新建)
- `src/dom/TimelinePanel.js`

**预计时间**: 20小时

---

#### 19. 插件系统 ⭐
**目标**: 支持第三方插件

**实现步骤**:
1. 定义插件API
2. 插件加载器
3. 插件管理器
4. 示例插件

**涉及文件**: 
- `src/plugins/PluginManager.js` (新建)
- `src/plugins/PluginAPI.js` (新建)

**预计时间**: 15小时

---

#### 20. WebGL加速渲染 ⭐
**目标**: 使用WebGL提升渲染性能

**实现步骤**:
1. 创建WebGL渲染器
2. 使用Phaser的WebGL管线
3. 优化大量对象渲染

**涉及文件**: 
- `src/dom/TimelinePanel.js`
- `src/phaser/renderers/TimelineRenderer.js` (新建)

**预计时间**: 10小时

---

## 📋 未实现功能完整清单

### A. Phaser 3 Timeline系统

**Timeline对象**
- [ ] Timeline.add()
- [ ] Timeline.play()
- [ ] Timeline.pause()
- [ ] Timeline.resume()
- [ ] Timeline.stop()
- [ ] Timeline.reset()
- [ ] Timeline.seek()
- [ ] Timeline.getProgress()
- [ ] Timeline.setTimeScale()

**Tween系统**
- [ ] Tween.to()
- [ ] Tween.from()
- [ ] Tween.chain()
- [ ] Tween.yoyo()
- [ ] Tween.repeat()
- [ ] Tween.delay()
- [ ] Tween.hold()
- [ ] Tween.repeatDelay()

**缓动函数**
- [ ] Linear
- [ ] Quad (In/Out/InOut)
- [ ] Cubic (In/Out/InOut)
- [ ] Quart (In/Out/InOut)
- [ ] Quint (In/Out/InOut)
- [ ] Sine (In/Out/InOut)
- [ ] Expo (In/Out/InOut)
- [ ] Circ (In/Out/InOut)
- [ ] Back (In/Out/InOut)
- [ ] Bounce (In/Out/InOut)
- [ ] Elastic (In/Out/InOut)
- [ ] Stepped

**关键帧动画**
- [ ] 定义关键帧序列
- [ ] 关键帧插值
- [ ] 关键帧缓动
- [ ] 关键帧持续时间
- [ ] 关键帧偏移

**动画事件**
- [ ] onStart
- [ ] onUpdate
- [ ] onComplete
- [ ] onLoop
- [ ] onYoyo
- [ ] onRepeat
- [ ] onPause
- [ ] onResume

### B. 编辑器功能

**选择和操作**
- [ ] 单选时间条
- [ ] 多选时间条（Ctrl+点击）
- [ ] 框选时间条
- [ ] 全选时间条（Ctrl+A）
- [ ] 反选时间条
- [ ] 选择同类型热区
- [ ] 选择同图层热区

**时间条编辑**
- [ ] 拖拽整个时间条移动
- [ ] 批量移动选中的时间条
- [ ] 复制时间条（Ctrl+C）
- [ ] 粘贴时间条（Ctrl+V）
- [ ] 剪切时间条（Ctrl+X）
- [ ] 删除时间条（Delete）
- [ ] 分割时间条
- [ ] 合并时间条
- [ ] 修剪时间条

**对齐和吸附**
- [ ] 吸附到网格
- [ ] 吸附到其他时间条
- [ ] 吸附到播放头
- [ ] 吸附到标记点
- [ ] 左对齐时间条
- [ ] 右对齐时间条
- [ ] 居中对齐时间条
- [ ] 均匀分布时间条

**时间标记**
- [ ] 添加时间标记
- [ ] 删除时间标记
- [ ] 编辑标记名称
- [ ] 跳转到标记
- [ ] 标记颜色分类
- [ ] 标记导出/导入

**时间区域**
- [ ] 选择时间区域
- [ ] 循环播放区域
- [ ] 导出时间区域
- [ ] 删除区域内热区
- [ ] 复制区域内热区

### C. 显示功能

**图层显示**
- [ ] 按图层分组显示
- [ ] 图层折叠/展开
- [ ] 图层重命名
- [ ] 图层显示/隐藏
- [ ] 图层锁定/解锁
- [ ] 图层颜色标识
- [ ] 图层高度调整

**缩略图和预览**
- [ ] 热区缩略图
- [ ] 视频帧预览
- [ ] 悬停预览
- [ ] 缩略图大小调整
- [ ] 缩略图缓存

**视图控制**
- [ ] 水平滚动
- [ ] 垂直滚动
- [ ] 缩放到适应（Fit）
- [ ] 缩放到选中
- [ ] 重置视图
- [ ] 保存视图状态
- [ ] 迷你地图（Overview）
- [ ] 分屏显示

**标尺和网格**
- [ ] 时间标尺单位切换（秒/帧/毫秒）
- [ ] 帧率设置（24fps/30fps/60fps）
- [ ] 网格显示
- [ ] 网格间隔调整
- [ ] 次级刻度线
- [ ] 时间码显示（HH:MM:SS:FF）

### D. 交互功能

**鼠标交互**
- [ ] 双击时间条编辑
- [ ] 右键菜单
- [ ] 中键拖拽平移
- [ ] 拖拽播放头跳转
- [ ] 点击时间轴跳转
- [ ] 拖拽选择区域
- [ ] 悬停显示详细信息

**键盘快捷键**
- [ ] 左/右箭头 - 微调时间
- [ ] Shift+左/右 - 快速移动
- [ ] Home - 跳转到开始
- [ ] End - 跳转到结束
- [ ] Space - 播放/暂停
- [ ] [ / ] - 设置入点/出点
- [ ] I / O - 标记入点/出点
- [ ] M - 添加标记
- [ ] , / . - 上一帧/下一帧

**触摸支持**
- [ ] 双指缩放
- [ ] 单指拖拽
- [ ] 长按菜单
- [ ] 手势识别

**工具提示**
- [ ] 显示精确时间
- [ ] 显示持续时间
- [ ] 显示热区信息
- [ ] 显示帧数
- [ ] 自定义工具提示内容

### E. 数据和同步

**实时同步**
- [ ] 时间轴 → Scene 实时同步
- [ ] Scene → 时间轴 实时同步
- [ ] 双向数据绑定
- [ ] 冲突检测
- [ ] 自动保存

**历史记录**
- [ ] 撤销时间调整
- [ ] 重做时间调整
- [ ] 历史记录列表
- [ ] 历史记录限制
- [ ] 清空历史记录

**数据验证**
- [ ] 时间范围验证
- [ ] 重叠检测
- [ ] 间隙检测
- [ ] 自动修复
- [ ] 警告提示

### F. 性能优化

**渲染优化**
- [ ] 虚拟滚动
- [ ] 离屏Canvas
- [ ] 脏矩形优化
- [ ] requestAnimationFrame
- [ ] Canvas分层
- [ ] WebGL渲染加速
- [ ] 对象池

**数据优化**
- [ ] 数据分页加载
- [ ] 懒加载
- [ ] 数据压缩
- [ ] 增量更新
- [ ] 缓存策略

**事件优化**
- [ ] 事件节流
- [ ] 事件防抖
- [ ] 事件委托
- [ ] 被动事件监听

### G. 导出和集成

**导出功能**
- [ ] 导出为JSON
- [ ] 导出为CSV
- [ ] 导出为XML
- [ ] 导出时间轴截图
- [ ] 导出视频关键帧
- [ ] 导出字幕文件（SRT/VTT）
- [ ] 导出After Effects数据

**导入功能**
- [ ] 导入JSON数据
- [ ] 导入CSV数据
- [ ] 导入字幕文件
- [ ] 导入标记点
- [ ] 批量导入

**插件系统**
- [ ] 自定义渲染器
- [ ] 自定义工具
- [ ] 自定义快捷键
- [ ] 扩展API
- [ ] 插件管理器

### H. 高级功能

**音频时间轴**
- [ ] 音频波形显示
- [ ] 音频标记
- [ ] 音频同步
- [ ] 音频淡入淡出

**视频时间轴**
- [ ] 视频帧显示
- [ ] 场景检测
- [ ] 自动标记
- [ ] 视频剪辑

**协作功能**
- [ ] 多用户编辑
- [ ] 实时同步
- [ ] 冲突解决
- [ ] 版本控制
- [ ] 评论系统

**搜索和过滤**
- [ ] 按名称搜索
- [ ] 按类型过滤
- [ ] 按时间范围过滤
- [ ] 按图层过滤
- [ ] 按颜色过滤
- [ ] 高级搜索

**自动化**
- [ ] 批量操作
- [ ] 脚本支持
- [ ] 宏录制
- [ ] 模板系统
- [ ] 预设管理

---

## 📅 实施时间表

### 第1周：P0功能（核心修复）
- Day 1-2: 播放头拖拽 + 点击跳转
- Day 3-4: 撤销/重做集成
- Day 5: 工具提示

### 第2-3周：P1功能（用户体验）
- Week 2: 图层分组 + 多选 + 拖拽整体
- Week 3: 键盘快捷键 + 右键菜单 + 吸附

### 第4-6周：P2功能（增强功能）
- Week 4: 时间标记系统
- Week 5: 虚拟滚动 + 缩略图
- Week 6: 时间区域 + 导出

### 第7周+：P3功能（高级功能）
- 根据需求逐步实现

---

## 🔧 技术要求

### 必须遵循
1. **Phaser 3 官方标准** - 所有代码符合Phaser规范
2. **Manager模式** - 使用Manager分离职责
3. **事件系统** - 使用Registry和Events通信
4. **性能优化** - 避免不必要的重绘
5. **代码简洁** - 单文件不超过200行

### 推荐使用
- TypeScript类型定义
- 单元测试
- 性能监控
- 错误处理

---

## 📝 注意事项

1. **每次只实现一个功能**，完成后测试再继续
2. **保持代码整洁**，及时重构
3. **添加注释**，说明复杂逻辑
4. **性能优先**，避免过度优化
5. **用户体验**，确保交互流畅

---

## 🎯 最终目标

打造一个**专业级视频编辑器时间轴**，功能完整、性能优秀、体验流畅，完全符合Phaser 3官方标准。

---

**创建时间**: 2025-01-26
**最后更新**: 2025-01-26
**版本**: 1.0.0
